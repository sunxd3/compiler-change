schema_version: "1.0"

# Reviewed and enhanced by second analyst on 2026-01-22

pr:
  number: 60449
  title: "Backports for 1.12.4"
  url: "https://github.com/JuliaLang/julia/pull/60449"
  author: "KristofferC"
  labels: []
  merged_at: "2025-12-22T21:06:29Z"
  merge_commit_sha: "4539b7b4af8c89dadc72bd079965bd1583bb84b4"
  diff_url: "https://github.com/JuliaLang/julia/pull/60449.diff"
  backports:
    - pr: 60326
      title: "Don't create a subprocess in the REPL precompile script"
      cherry_picked_from: "18aa2377728fb6c4f5b2b388f76690c1d3f8e3cb"
    - pr: 60419
      title: "[backports-release-1.12] Fix 7z rpath"
      fixes_issue: 60220
      original_fix_pr: 60098

scope:
  files_touched:
    - "Make.inc"
    - "Makefile"
    - "stdlib/REPL/src/precompile.jl"
  components:
    - "BuildSystem"
    - "REPL"
  pipeline_stages: []

analysis:
  intent:
    summary: |
      Combined backport PR for Julia 1.12.4 containing two bug fixes:
      1. Fix deadlocks in REPL precompilation by removing subprocess spawning
      2. Fix incorrect rpath for private executables (7z, zstd) causing library load failures on older Linux systems
    issue_links:
      - "https://github.com/JuliaLang/julia/issues/60220"
      - "https://github.com/JuliaLang/julia/issues/24440"
      - "https://github.com/JuliaLang/julia/issues/60141"

  direct_changes:
    - summary: "Fix reverse_private_libexecdir_rel path calculation in Make.inc"
      component: "BuildSystem"
      evidence:
        - source: "diff"
          path: "Make.inc"
          loc: "389"
          url: "https://github.com/JuliaLang/julia/blob/4539b7b4af8c89dadc72bd079965bd1583bb84b4/Make.inc#L389"
          snippet: |
            # BEFORE (incorrect):
            reverse_private_libexecdir_rel_eval = $(call rel_path,$(private_libexecdir),$(libdir))

            # AFTER (correct):
            reverse_private_libexecdir_rel_eval = $(call rel_path,$(private_libexecdir),$(private_libdir))
      description: |
        The relative path from private_libexecdir was incorrectly computed relative to libdir instead of
        private_libdir. This caused private executables (7z, zstd, lld, dsymutil) to have incorrect rpath
        entries, preventing them from finding bundled shared libraries.

        Directory layout (typical Linux installation):
          libdir            = $(prefix)/lib           -> /usr/lib
          libexecdir        = $(prefix)/libexec       -> /usr/libexec
          private_libdir    = $(libdir)/julia         -> /usr/lib/julia
          private_libexecdir = $(libexecdir)/julia    -> /usr/libexec/julia

        The rpath tells executables where to find their libraries relative to $ORIGIN:
          BEFORE (wrong): rel_path(/usr/libexec/julia, /usr/lib) = ../lib
            -> 7z in /usr/libexec/julia looked for libc++.so in /usr/lib (not found)
          AFTER (correct): rel_path(/usr/libexec/julia, /usr/lib/julia) = ../../lib/julia
            -> 7z in /usr/libexec/julia correctly finds libc++.so in /usr/lib/julia

    - summary: "Add rpath patching for JL_PRIVATE_TOOLS and JL_PRIVATE_EXES in Makefile"
      component: "BuildSystem"
      evidence:
        - source: "code"
          path: "Makefile"
          loc: "530-558"
          url: "https://github.com/JuliaLang/julia/blob/4539b7b4af8c89dadc72bd079965bd1583bb84b4/Makefile#L530-L558"
          snippet: |
            ifeq ($(OS), Darwin)
            ifneq ($(DARWIN_FRAMEWORK),1)
            	for j in $(JL_PRIVATE_TOOLS) ; do \
            		[ -L $(DESTDIR)$(private_libexecdir)/$$j ] && continue; \
            		install_name_tool -rpath @loader_path/$(build_libdir_rel) @executable_path/$(reverse_private_libexecdir_rel) $(DESTDIR)$(private_libexecdir)/$$j || exit 1; \
            	done
            endif
            else ifneq (,$(findstring $(OS),Linux FreeBSD))
            	for j in $(JL_PRIVATE_TOOLS) ; do \
            		[ -L $(DESTDIR)$(private_libexecdir)/$$j ] && continue; \
            		$(PATCHELF) $(PATCHELF_SET_RPATH_ARG) '$$ORIGIN/$(reverse_private_libexecdir_rel)' $(DESTDIR)$(private_libexecdir)/$$j || exit 1; \
            	done
            endif
        - source: "code"
          path: "Makefile"
          loc: "245-281"
          url: "https://github.com/JuliaLang/julia/blob/4539b7b4af8c89dadc72bd079965bd1583bb84b4/Makefile#L245-L281"
          snippet: |
            # Private executables defined in Makefile:
            JL_PRIVATE_EXES := 7z
            JL_PRIVATE_TOOLS :=
            # ...later additions:
            JL_PRIVATE_EXES += zstd$(EXE) zstdmt$(EXE)
            JL_PRIVATE_TOOLS += lld$(EXE) dsymutil$(EXE)
      description: |
        New build rules to patch rpath entries for private executables after installation:
        - Darwin: Uses install_name_tool to update Mach-O binary load paths
        - Linux/FreeBSD: Uses patchelf to update ELF RPATH entries

        Executables affected:
        - JL_PRIVATE_EXES: 7z, zstd, zstdmt (archive tools used by Pkg/Artifacts)
        - JL_PRIVATE_TOOLS: lld, dsymutil (LLVM tools used for linking/debug)

        Note: On macOS, 7z is explicitly skipped in the JL_PRIVATE_EXES loop (line 548:
        "[ $$j = 7z ] && continue") because its rpath is already handled correctly
        during the build phase. Only lld, dsymutil, zstd need post-install patching on macOS.

    - summary: "Remove shell subprocess from REPL precompile workload"
      component: "REPL"
      evidence:
        - source: "diff"
          path: "stdlib/REPL/src/precompile.jl"
          loc: "79-81"
          url: "https://github.com/JuliaLang/julia/blob/4539b7b4af8c89dadc72bd079965bd1583bb84b4/stdlib/REPL/src/precompile.jl#L79-L81"
          snippet: |
            # BEFORE (line 79 in old version):
            ; pwd

            # AFTER (lines 80-81):
            ;
            $CTRL_C
        - source: "code"
          path: "stdlib/REPL/src/precompile.jl"
          loc: "71-84"
          url: "https://github.com/JuliaLang/julia/blob/4539b7b4af8c89dadc72bd079965bd1583bb84b4/stdlib/REPL/src/precompile.jl#L71-L84"
          snippet: |
            repl_script = """
            2+2
            print("")
            printstyled("a", "b")
            display([1])
            display([1 2; 3 4])
            display("a string")
            foo(x) = 1
            @time @eval foo(1)
            ;
            $CTRL_C
            $CTRL_R$CTRL_C#
            ? reinterpret
            using Ra\t$CTRL_C
      description: |
        Changed shell mode precompilation from "; pwd" to just ";" followed by CTRL_C.

        Key insight: Shell mode ENTRY is still precompiled (the ";" triggers mode switch),
        but no subprocess is spawned. The CTRL_C immediately cancels before any command runs.

        Why this matters:
        - The shell mode switching code (ShellCompletions, mode_keymap) still gets compiled
        - Only the subprocess spawning path (run() with external command) is avoided
        - This preserves most precompilation benefit while eliminating the deadlock trigger

        Root cause of deadlock: The subprocess (pwd) clears O_NONBLOCK flag on the PTY
        file descriptors, causing subsequent libuv I/O operations to block indefinitely.

  secondary_effects:
    - effect: "Restored library resolution for bundled executables on older Linux"
      mechanism: |
        With correct rpath, private executables can locate bundled shared libraries:

        Call chain for 7z library resolution:
          Pkg.jl: Registry.uncompress(path)  [Pkg/src/Registry/Registry.jl]
            -> calls 7z via run(pipeline(...))
            -> kernel loads 7z from /usr/lib/julia/../libexec/julia/7z
            -> ELF dynamic linker reads RPATH from 7z binary
            -> NEW (correct): $ORIGIN/../../lib/julia resolves to /usr/lib/julia
            -> finds libc++.so.1 bundled with Julia
            -> OLD (wrong): $ORIGIN/../lib resolves to /usr/lib (system libstdc++)
            -> GLIBC_1.3.8 missing on CentOS 7 -> crash

        Error message on affected systems:
          "/lib64/libstdc++.so.6: version 'CXXABI_1.3.8' not found (required by 7z)"
      downstream_surfaces:
        - "Pkg.jl (uses 7z for registry extraction and package archives)"
        - "Artifacts.jl (uses 7z/zstd for artifact decompression)"
        - "BinaryBuilder packages (all JLLs that bundle compressed artifacts)"
      likelihood: "high"
      impact: "high"

    - effect: "Eliminated PTY deadlock risk during sysimage precompilation"
      mechanism: |
        REPL precompile runs on raw PTY fds with O_NONBLOCK set for async I/O.

        Deadlock call chain:
          precompile.jl: repl_workload()  [stdlib/REPL/src/precompile.jl:17]
            -> open_fake_pty() returns (rawpts, ptm) with O_NONBLOCK set
            -> shell mode ";" triggers ShellCompletions.shell_mode()
            -> OLD: "; pwd" spawns subprocess via Base.run()
            -> subprocess calls tcsetattr() on PTY
            -> POSIX: tcsetattr() clears O_NONBLOCK flag (required for blocking shell I/O)
            -> subprocess exits, PTY remains in blocking mode
            -> libuv continues using blocking I/O
            -> uv_read() blocks indefinitely on PTY fd
            -> CI timeout after 60+ minutes with no error message

        NEW: "; $CTRL_C" enters shell mode but cancels before subprocess spawn,
        preserving O_NONBLOCK flag throughout precompilation.
      downstream_surfaces:
        - "CI/CD systems building Julia sysimages"
        - "Custom precompilation workflows"
        - "Any system running REPL precompilation with PTY-based I/O"
      likelihood: "medium"
      impact: "medium"

  compatibility:
    internal_api: []
    behavioral:
      - change: "7z and zstd executables now have correct rpath on Linux/FreeBSD"
        impact: "Fixes broken package updates on CentOS 7 and similar older systems"
        affected_versions: ["1.12.2", "1.12.3"]
        notes: |
          The rpath bug was introduced in Julia 1.12.2. Users on 1.12.0 and 1.12.1
          were not affected. CentOS 7 users on 1.12.2/1.12.3 could work around by
          running `julia +pr60419` or downgrading to 1.12.1.
      - change: "REPL precompilation no longer triggers shell mode subprocess"
        impact: |
          Shell mode entry code is still precompiled (mode switching, completions).
          Only subprocess execution code paths may see slightly higher first-use latency.
        affected_versions: ["1.12.x"]

  performance:
    compile_time:
      - description: |
          REPL precompilation scope after this change:

          STILL PRECOMPILED (shell mode entry):
            - ShellCompletions module initialization
            - Mode switching logic (julia mode -> shell mode)
            - Prompt rendering for shell mode
            - CTRL_C handling in shell context

          NOT PRECOMPILED (subprocess execution):
            - Base.run() with Cmd objects in shell context
            - Pipeline setup for external commands
            - Process spawning and wait logic

          ESTIMATED impact: <50ms additional latency on first `;cmd` invocation.
          This is a minor regression compared to the deadlock elimination benefit.
    runtime: []

  risk:
    level: "low"
    rationale:
      - "Build system fix is isolated to rpath patching during make install"
      - "REPL change is minimal removal of one test input line"
      - "No compiler or runtime code paths affected"
      - "Both changes are pure bug fixes with no semantic changes to Julia behavior"

  open_questions: []

  recommendations:
    - "Users on CentOS 7 or similar older Linux systems experiencing 'CXXABI_1.3.8 not found' errors with 7z should upgrade to 1.12.4+"
    - "CI systems experiencing mysterious precompilation timeouts (60+ min hangs) should upgrade to include this fix"
    - "Users running containerized Julia builds that strip system libstdc++ should upgrade"
    - "No action needed for downstream compiler-dependent packages (JET, Enzyme, GPUCompiler)"
    - "If stuck on 1.12.2/1.12.3, workaround: downgrade to 1.12.1 or install nightly with `julia +pr60419`"

categorization:
  is_compiler_change: false
  primary_category: "build-system"
  subcategories:
    - "rpath-handling"
    - "installation"
    - "precompilation"
  affects_downstream_compiler_tools: false
  notes: |
    This PR is a combined backport containing build system and REPL fixes only.
    It does not modify any compiler pipeline components (JuliaSyntax, JuliaLowering,
    Compiler/src/*, interpreter, codegen). Downstream packages that depend on
    compiler internals (JET, Enzyme, GPUCompiler) are unaffected.

reviewer_notes:
  reviewed_by: "second_analyst"
  review_date: "2026-01-22"
  verification_method: |
    - Read Make.inc lines 340-395 to verify directory layout definitions
    - Examined Makefile lines 240-290 for JL_PRIVATE_EXES/TOOLS definitions
    - Traced full rpath patching logic in Makefile lines 480-560
    - Reviewed REPL precompile.jl repl_workload() function in full
    - Cross-referenced with GitHub issues #60220, #60141, and PRs #60326, #60419
  enhancements_made:
    - "Added concrete directory path calculations showing before/after rpath values"
    - "Clarified that shell mode ENTRY is still precompiled (only subprocess spawn avoided)"
    - "Added detailed call chains for library resolution and deadlock mechanism"
    - "Corrected affected_versions (1.12.2/1.12.3, not 1.12.0-1.12.2)"
    - "Added macOS-specific 7z handling note (line 548 skip)"
    - "Expanded downstream_surfaces to include BinaryBuilder JLLs"
    - "Added workaround recommendations for users stuck on affected versions"
  original_analysis_quality: "good"
  additional_findings: |
    The original analysis correctly identified both bugs and their fixes.
    Enhancement focused on adding concrete evidence (directory paths, call chains)
    and correcting version information based on the linked GitHub issue #60220.
