schema_version: "1.0"
pr:
  number: 60297
  title: "Fix copy-paste error in effect comparison"
  url: "https://github.com/JuliaLang/julia/pull/60297"
  author: "Keno"
  labels: []
  merged_at: "2025-12-02T09:49:46Z"
  merge_commit_sha: "758718094f4922a63816572fe8f0b1fe364bb559"
  diff_url: "https://github.com/JuliaLang/julia/pull/60297.diff"
scope:
  files_touched:
    - "Compiler/src/effects.jl"
  components:
    - "Compiler.Effects"
  pipeline_stages:
    - "TypeInference"
    - "Effects"
analysis:
  intent:
    summary: "Fix an effects-comparison bug so the effect_free bit is compared against the prior effect_free value (not the consistent bit)."
    issue_links: []
  direct_changes:
    - summary: "Correct the ALWAYS_TRUE effect_free comparison in is_better_effects to look at old.effect_free instead of old.consistent."
      component: "Compiler.Effects"
      evidence:
        - source: "code"
          path: "Compiler/src/effects.jl"
          loc: "205-225"
          url: "https://github.com/JuliaLang/julia/blob/758718094f4922a63816572fe8f0b1fe364bb559/Compiler/src/effects.jl#L205-L225"
          snippet: |
            function is_better_effects(new::Effects, old::Effects)
                any_improved = false
                if new.consistent == ALWAYS_TRUE
                    any_improved |= old.consistent != ALWAYS_TRUE
                else
                    if !iszero(new.consistent & CONSISTENT_IF_NOTRETURNED)
                        old.consistent == ALWAYS_TRUE && return false
                        any_improved |= iszero(old.consistent & CONSISTENT_IF_NOTRETURNED)
                    elseif !iszero(new.consistent & CONSISTENT_IF_INACCESSIBLEMEMONLY)
                        old.consistent == ALWAYS_TRUE && return false
                        any_improved |= iszero(old.consistent & CONSISTENT_IF_INACCESSIBLEMEMONLY)
                    else
                        return false
                    end
                end
                if new.effect_free == ALWAYS_TRUE
                    any_improved |= old.effect_free != ALWAYS_TRUE
                elseif new.effect_free == EFFECT_FREE_IF_INACCESSIBLEMEMONLY
                    old.effect_free == ALWAYS_TRUE && return false
                    any_improved |= old.effect_free != EFFECT_FREE_IF_INACCESSIBLEMEMONLY
                elseif new.effect_free != old.effect_free
                    return false
                end
    - summary: "Existing tests assert effect_free results for removable-if-unused patterns (no test changes in this PR)."
      component: "Compiler.Tests"
      evidence:
        - source: "test"
          path: "Compiler/test/effects.jl"
          loc: "637-655"
          url: "https://github.com/JuliaLang/julia/blob/758718094f4922a63816572fe8f0b1fe364bb559/Compiler/test/effects.jl#L637-L655"
          snippet: |
            for f = Any[removable_if_unused1, removable_if_unused2]
                effects = Base.infer_effects(f)
                @test Compiler.is_inaccessiblememonly(effects)
                @test Compiler.is_effect_free(effects)
                @test Compiler.is_removable_if_unused(effects)
                @test @eval fully_eliminated() do
                    $f()
                    nothing
                end
            end
            @noinline function removable_if_unused3(v)
                x = makeref()
                setref!(x, v)
                x
            end
            let effects = Base.infer_effects(removable_if_unused3, (Int,))
                @test Compiler.is_inaccessiblememonly(effects)
                @test Compiler.is_effect_free(effects)
                @test Compiler.is_removable_if_unused(effects)
            end
  secondary_effects:
    - effect: "Const-prop inference will now accept effect_free improvements when type results are worse but effects improve."
      mechanism: |
        abstract_call_method_with_const_args(...)  [abstractinterpretation.jl:177]
          produces const_call_result.effects
        -> is_better_effects(const_call_result.effects, effects)  [abstractinterpretation.jl:194]
          compares effect_free via old.effect_free in is_better_effects  [effects.jl:220-224]
        -> effects updated to const-prop result when effect_free improves
      downstream_surfaces:
        - "Const-prop effect selection during inference"
        - "Effect-based inlining / removal decisions"
      likelihood: "medium"
      impact: "low"
  compatibility:
    internal_api: []
    behavioral:
      - "Const-prop may retain effect_free improvements that were previously ignored due to the mistaken comparison against old.consistent."
  performance:
    compile_time:
      - "ESTIMATED: no measurable change; a single branch uses the correct field during comparison."
    runtime:
      - "ESTIMATED: no measurable change; effect metadata only influences optimizer decisions."
  risk:
    level: "low"
    rationale:
      - "Single-field comparison fix in an internal effect comparator, with narrow scope."
  open_questions: []
  recommendations:
    - "Downstream tooling that relies on effect_free outcomes from const-prop should re-run effect-related tests to confirm expectations."
