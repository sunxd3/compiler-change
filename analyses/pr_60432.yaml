schema_version: "1.0"
pr:
  number: 60432
  title: "[JuliaLowering] fix `@nospecialize` on unnamed arguments"
  url: "https://github.com/JuliaLang/julia/pull/60432"
  author: "aviatesk"
  labels: []
  merged_at: "2025-12-22T18:47:35Z"
  merge_commit_sha: "b7a217c55c07d7c975b2d1250f832731c2053284"
  diff_url: "https://github.com/JuliaLang/julia/pull/60432.diff"
scope:
  files_touched:
    - "JuliaLowering/src/desugaring.jl"
    - "JuliaLowering/src/linear_ir.jl"
    - "JuliaLowering/test/functions.jl"
  components:
    - "JuliaLowering"
  pipeline_stages:
    - "Lowering"
    - "LinearIR"
analysis:
  intent:
    summary: "Propagate @nospecialize metadata for placeholder (unnamed) arguments through lowering and linear IR so the resulting Method nospecialize bitset matches user annotations."
    issue_links:
      - "https://github.com/JuliaLang/julia/issues/44428"
  direct_changes:
    - summary: "Desugaring now copies :nospecialize metadata onto synthesized placeholder argument bindings so unnamed arguments preserve @nospecialize during lowering."
      component: "JuliaLowering desugaring"
      evidence:
        - source: "code"
          path: "JuliaLowering/src/desugaring.jl"
          loc: "2330-2339"
          url: "https://github.com/JuliaLang/julia/blob/b7a217c55c07d7c975b2d1250f832731c2053284/JuliaLowering/src/desugaring.jl#L2330-L2339"
          snippet: |
            elseif k == K"Placeholder"
                # Lowering should be able to use placeholder args as rvalues internally,
                # e.g. for kw method dispatch.  Duplicate positional placeholder names
                # should be allowed.
                is_nospecialize = getmeta(ex, :nospecialize, false)
                name = if is_kw
                    @ast ctx ex ex=>K"Identifier"
                else
                    new_local_binding(ctx, ex, "#arg$(string(arg_id))#"; kind=:argument,
                                      is_nospecialize=is_nospecialize)
                end
    - summary: "Linear IR slots for placeholder arguments now read :nospecialize metadata directly, ensuring CodeInfo meta is emitted for unnamed arguments." 
      component: "JuliaLowering linear_ir"
      evidence:
        - source: "code"
          path: "JuliaLowering/src/linear_ir.jl"
          loc: "1065-1070"
          url: "https://github.com/JuliaLang/julia/blob/b7a217c55c07d7c975b2d1250f832731c2053284/JuliaLowering/src/linear_ir.jl#L1065-L1070"
          snippet: |
            for arg in children(lambda_args)
                if kind(arg) == K"Placeholder"
                    # Unused functions arguments like: `_` or `::T`
                    push!(slots, Slot(arg.name_val, :argument, getmeta(arg, :nospecialize, false),
                                      false, false, false, false))
  secondary_effects:
    - effect: "@nospecialize on unnamed arguments now survives all the way to emitted CodeInfo meta, so Method.nospecialize bitsets reflect placeholder annotations."
      mechanism: |
        expand_function_arg(...) [desugaring.jl:2330-2339]
          -> new_local_binding(..., is_nospecialize=...) [bindings.jl:132-143]
          -> compile_lambda(...) builds Slot(..., is_nospecialize=...) for placeholders [linear_ir.jl:1065-1070]
          -> _to_codeinfo emits Expr(:meta, :nospecialize, Core.SlotNumber(i)) when slot.is_nospecialize [eval.jl:246-250]
      downstream_surfaces:
        - "Method.nospecialize bitset"
        - "CodeInfo :nospecialize meta on placeholder slots"
      likelihood: "high"
      impact: "low"
  compatibility:
    internal_api:
      - impact: "Method.nospecialize now includes bits for unnamed placeholder arguments when annotated, which may change expectations in tooling that inspects Method.nospecialize for specialization control."
        evidence:
          - source: "code"
            path: "JuliaLowering/src/eval.jl"
            loc: "241-250"
            url: "https://github.com/JuliaLang/julia/blob/b7a217c55c07d7c975b2d1250f832731c2053284/JuliaLowering/src/eval.jl#L241-L250"
            snippet: |
              slotflags[i] =                   # Inference          | Codegen
                  slot.is_read          << 3 | # SLOT_USED          | jl_vinfo_sa
                  slot.is_single_assign << 4 | # SLOT_ASSIGNEDONCE  | -
                  slot.is_maybe_undef   << 5 | # SLOT_USEDUNDEF     | jl_vinfo_usedundef
                  slot.is_called        << 6   # SLOT_CALLED        | -
              if slot.is_nospecialize
                  # Ideally this should be a slot flag instead
                  add_ir_debug_info!(current_codelocs_stack, ex)
                  push!(stmts, Expr(:meta, :nospecialize, Core.SlotNumber(i)))
              end
    behavioral:
      - impact: "User code with @nospecialize on unnamed arguments now produces the expected nospecialize bitmask in tests, aligning runtime specialization behavior with annotations."
        evidence:
          - source: "test"
            path: "JuliaLowering/test/functions.jl"
            loc: "328-334"
            url: "https://github.com/JuliaLang/julia/blob/b7a217c55c07d7c975b2d1250f832731c2053284/JuliaLowering/test/functions.jl#L328-L334"
            snippet: |
              # @nospecialize on unnamed arguments (issue #44428)
              JuliaLowering.include_string(test_mod, """
              function f_nospecialize_unnamed(@nospecialize(::Any), @nospecialize(x::Any))
                  x
              end
              """)
              @test only(methods(test_mod.f_nospecialize_unnamed)).nospecialize == 0b11
  performance:
    compile_time:
      - impact: "ESTIMATED: slightly reduced specialization work for methods that use unnamed @nospecialize arguments (now correctly marked), which can lower method instance churn in codegen."
    runtime:
      - impact: "ESTIMATED: no runtime behavior change beyond honoring the existing @nospecialize annotation; specialization decisions align with user intent."
  risk:
    level: "low"
    rationale:
      - "Change is limited to propagating existing metadata for placeholder arguments and is guarded by tests for Method.nospecialize."
      - "No changes to inference or optimization passes beyond carrying metadata into slots."
  open_questions: []
  recommendations:
    - "Downstream tooling that inspects Method.nospecialize should include placeholder (unnamed) arguments in its expectations going forward."
