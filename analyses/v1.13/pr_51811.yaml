schema_version: "1.0"

pr:
  number: 51811
  title: "Make banner size depend on terminal size"
  url: "https://github.com/JuliaLang/julia/pull/51811"
  diff_url: "https://github.com/JuliaLang/julia/pull/51811.diff"
  author: "tecosaur"
  labels:
    - "REPL"
    - "display and printing"
    - "reverted"
  merged_at: "2025-10-25T15:34:09Z"
  merge_commit_sha: "1ab0e32dd52576c93c477103e1b77f91e7cf26ed"

scope:
  files_touched:
    - "base/client.jl"
    - "src/jloptions.c"
    - "stdlib/REPL/src/REPL.jl"
    - "stdlib/REPL/src/precompile.jl"
    - "stdlib/REPL/test/repl.jl"
    - "test/cmdlineargs.jl"
  components:
    - "REPL"
    - "CLI"
    - "Display"
  pipeline_stages: []

analysis:
  intent:
    summary: |
      Redesigns the Julia REPL startup banner to dynamically select one of four size variants
      (tiny, short, narrow, full) based on terminal dimensions using displaysize(io), preventing
      visual overflow/reflow issues on small terminals. Uses StyledStrings for modern terminal
      rendering with colors and hyperlinks.
    issue_links: []

  direct_changes:
    - summary: "Expanded --banner CLI option from {yes|no|auto|short} to {yes|no|auto|full|narrow|short|tiny}"
      component: "CLI"
      evidence:
        - source: "code"
          path: "src/jloptions.c"
          loc: "614-631"
          url: "https://github.com/JuliaLang/julia/blob/1ab0e32dd52576c93c477103e1b77f91e7cf26ed/src/jloptions.c#L614-L631"
          snippet: |
            case opt_banner: // banner
                if (!strcmp(optarg, "auto"))
                    jl_options.banner = -1;
                else if (!strcmp(optarg, "no"))
                    jl_options.banner = 0;
                else if (!strcmp(optarg, "yes"))
                    jl_options.banner = 1;
                else if (!strcmp(optarg, "full"))
                    jl_options.banner = 1; // Same as "yes".
                else if (!strcmp(optarg, "narrow"))
                    jl_options.banner = 2;
                else if (!strcmp(optarg, "short"))
                    jl_options.banner = 3;
                else if (!strcmp(optarg, "tiny"))
                    jl_options.banner = 4;
                else
                    jl_errorf("julia: invalid argument to --banner={yes|no|auto|full|narrow|short|tiny} (%s)", optarg);
                break;

    - summary: "Changed REPL.banner() signature from keyword argument to positional symbol"
      component: "REPL"
      evidence:
        - source: "code"
          path: "stdlib/REPL/src/REPL.jl"
          loc: "1767-1777"
          url: "https://github.com/JuliaLang/julia/blob/1ab0e32dd52576c93c477103e1b77f91e7cf26ed/stdlib/REPL/src/REPL.jl#L1767-L1777"
          snippet: |
            """
                banner(io::IO = stdout, preferred::Symbol = :full)

            Print the "Julia" informative banner to `io`, using the `preferred` variant
            if reasonable and known.

            !!! warning
                The particular banner selected by `preferred` is liable to being changed
                without warning. The current variants are: `:tiny`, `:short`, `:narrow`, and `:full`.
            """
            function banner(io::IO = stdout, preferred::Symbol = :full)

    - summary: "Added dynamic banner size selection based on displaysize(io)"
      component: "REPL"
      evidence:
        - source: "code"
          path: "stdlib/REPL/src/REPL.jl"
          loc: "1804-1810"
          url: "https://github.com/JuliaLang/julia/blob/1ab0e32dd52576c93c477103e1b77f91e7cf26ed/stdlib/REPL/src/REPL.jl#L1804-L1810"
          snippet: |
            sizenames = (:tiny, :short, :narrow, :full)
            maxsize = something(findfirst(==(preferred), sizenames), length(sizenames))
            size = min(if     all(displaysize(io) .>= (8, 70)); 4 # Full size
                       elseif all(displaysize(io) .>= (8, 45)); 3 # Narrower
                       elseif all(displaysize(io) .>= (3, 50)); 2 # Tiny
                       else 1 end,
                       max(0, maxsize))

    - summary: "Redesigned banner output using StyledStrings with colors and hyperlinks"
      component: "REPL"
      evidence:
        - source: "code"
          path: "stdlib/REPL/src/REPL.jl"
          loc: "1812-1849"
          url: "https://github.com/JuliaLang/julia/blob/1ab0e32dd52576c93c477103e1b77f91e7cf26ed/stdlib/REPL/src/REPL.jl#L1812-L1849"
          snippet: |
            if size == 4 # Full size
                print(io, styled"""
                                         {bold,green:_}
                             {bold,blue:_}       _ {bold:{red:_}{green:(_)}{magenta:_}}     {shadow:|}  $doclink
                            {bold,blue:(_)}     | {bold:{red:(_)} {magenta:(_)}}    {shadow:|}
                             _ _   _| |_  __ _   {shadow:|}  $help
                            | | | | | | |/ _` |  {shadow:|}
                            | | |_| | | | (_| |  {shadow:|}  Version {bold:$VERSION}$commit_date
                           _/ |\\__'_|_|_|\\__'_|  {shadow:|}  $commit_string
                          |__/                   {shadow:|}
                          \n""")
            elseif size == 3 # Rotated (narrow)
                # ... narrower variant with stacked info below logo ...
            elseif size == 2 # Tiny
                print(io, styled"""
                             {bold,green:o}  {shadow:|} Version {bold:$VERSION}$commit_date
                            {bold:{red:o} {magenta:o}} {shadow:|} $commit_string
                           """, ifelse(displaysize(io) > (12, 0), "\n", ""))
            elseif size == 1 # Text only
                print(io, styled"""{bold:{blue:therefore} {magenta:Julia} $VERSION}$commit_date\n""")

    - summary: "Updated repl_main() to map new banner values to symbols"
      component: "REPL"
      evidence:
        - source: "code"
          path: "base/client.jl"
          loc: "607-632"
          url: "https://github.com/JuliaLang/julia/blob/1ab0e32dd52576c93c477103e1b77f91e7cf26ed/base/client.jl#L607-L632"
          snippet: |
            function repl_main(_)
                opts = Base.JLOptions()
                interactiveinput = isa(stdin, Base.TTY)
                bval = if opts.banner == -1 # Auto
                    Int(interactiveinput)
                else
                    opts.banner
                end
                # All the options produced by `jloptions.c`'s `case opt_banner`.
                # 0=off, 1=largest, ..., N=smallest
                banner = if bval == 0
                    :no
                elseif bval == 1
                    :full
                elseif bval == 2
                    :narrow
                elseif bval == 3
                    :short
                elseif bval == 4
                    :tiny
                else # For type stability of `banner`
                    :unreachable
                end
                quiet                 = (opts.quiet != 0)
                history_file          = (opts.historyfile != 0)
                return run_main_repl(interactiveinput, quiet, banner, history_file)

    - summary: "Added precompilation hints for StyledStrings/AnnotatedString banner rendering"
      component: "REPL"
      evidence:
        - source: "code"
          path: "stdlib/REPL/src/precompile.jl"
          loc: "214-227"
          url: "https://github.com/JuliaLang/julia/blob/1ab0e32dd52576c93c477103e1b77f91e7cf26ed/stdlib/REPL/src/precompile.jl#L214-L227"
          snippet: |
            # For the banner
            # TODO: Fix precompilation so this is no longer needed
            precompile(Tuple{typeof(Base.AnnotatedDisplay.ansi_write), typeof(Base.write), Base.TTY, Base.AnnotatedString{String}})
            precompile(Tuple{typeof(Base.all), Tuple{Bool, Bool}})
            precompile(Tuple{typeof(Base.get), Base.Dict{Tuple{Symbol, Any}, Int64}, Tuple{Symbol, REPL.StyledStrings.Face}, Int64})
            precompile(Tuple{typeof(Base.get), Base.Dict{Tuple{Symbol, Any}, Int64}, Tuple{Symbol, String}, Int64})
            precompile(Tuple{typeof(Base.get), Base.Dict{Tuple{Symbol, Any}, Int64}, Tuple{Symbol, Symbol}, Int64})
            precompile(Tuple{typeof(Base.hashindex), Tuple{Symbol, String}, Int64})
            precompile(Tuple{typeof(Base.isempty), Base.Dict{String, Any}})
            precompile(Tuple{typeof(Base.print), Base.TTY, Base.AnnotatedString{String}})
            precompile(Tuple{typeof(Base.setindex!), Base.Dict{Tuple{Symbol, Any}, Int64}, Int64, Tuple{Symbol, REPL.StyledStrings.Face}})
            precompile(Tuple{typeof(Base.setindex!), Base.Dict{Tuple{Symbol, Any}, Int64}, Int64, Tuple{Symbol, String}})
            precompile(Tuple{typeof(Base.setindex!), Base.Dict{Tuple{Symbol, Any}, Int64}, Int64, Tuple{Symbol, Symbol}})
            precompile(Tuple{typeof(REPL.banner), Base.TTY})

  secondary_effects:
    - effect: "API signature change for REPL.banner()"
      mechanism: |
        Old signature: banner(io::IO = stdout; short = false)
        New signature: banner(io::IO = stdout, preferred::Symbol = :full)

        Call sites that break:
        - banner(io; short=true) -> must change to banner(io, :short) or banner(io, :tiny)
        - banner(short=true) -> must change to banner(stdout, :short)

        Call chain:
          run_std_repl(REPL, quiet, banner, history_file)  [base/client.jl:484]
            -> REPL.banner(term, banner)  [base/client.jl:487]
          run_frontend(repl::StreamREPL, backend)  [stdlib/REPL/src/REPL.jl:1855]
            -> banner(repl.stream)  [stdlib/REPL/src/REPL.jl:1855]
      downstream_surfaces:
        - "Any code calling REPL.banner() with keyword argument"
        - "REPL customization scripts"
      likelihood: "high"
      impact: "low"

    - effect: "Changed --banner=short numeric value from 2 to 3"
      mechanism: |
        Base.JLOptions().banner values changed:
        - Old: -1=auto, 0=no, 1=yes, 2=short
        - New: -1=auto, 0=no, 1=yes/full, 2=narrow, 3=short, 4=tiny

        Test expectations changed accordingly in test/cmdlineargs.jl:
          Old: @test read(`$exename --banner=short -e $p`, String) == "(0, 2)"
          New: @test read(`$exename --banner=short  -q -e $p`, String) == "(1, 3)"

        Code checking JLOptions().banner == 2 for "short" will now match "narrow".
      downstream_surfaces:
        - "Code inspecting Base.JLOptions().banner numeric value"
        - "Build systems or launchers that parse --banner values"
      likelihood: "medium"
      impact: "low"

    - effect: "StyledStrings dependency for banner rendering"
      mechanism: |
        Banner now uses styled"" string macros from StyledStrings module.
        Import at REPL.jl line 41: using Base.Meta, Sockets, StyledStrings

        Multiple styled"" literals are interpolated at lines:
          1781, 1790, 1794, 1800, 1801, 1802, 1813, 1824, 1841, 1846, 1848

        Terminals without ANSI color support will see AnnotatedString content
        rendered via Base.AnnotatedDisplay.ansi_write.
      downstream_surfaces:
        - "Non-ANSI terminal environments"
        - "Captured stdout parsing (may see ANSI escape codes)"
      likelihood: "low"
      impact: "low"

    - effect: "BUG: Missing Base. prefix for TAGGED_RELEASE_BANNER causes build failure"
      mechanism: |
        Line 1779 references TAGGED_RELEASE_BANNER without Base. prefix:
          Base.AnnotatedString(TAGGED_RELEASE_BANNER, :face => :shadow)

        Should be:
          Base.AnnotatedString(Base.TAGGED_RELEASE_BANNER, :face => :shadow)

        TAGGED_RELEASE_BANNER is defined in Base via base/Makefile:
          @printf "%s\n" "const TAGGED_RELEASE_BANNER = \"$(TAGGED_RELEASE_BANNER)\"" >> $@

        This code path only executes when Base.GIT_VERSION_INFO.tagged_commit is true,
        which only happens during official tagged release builds. During normal
        development builds, this branch is not taken, so the bug was not caught.

        Result: UndefVarError: `TAGGED_RELEASE_BANNER` not defined in `REPL`
        This error became hidden during precompilation, manifesting as a deadlock.
      downstream_surfaces:
        - "Tagged release builds"
        - "Official Julia binary distribution"
      likelihood: "high"
      impact: "high"

    - effect: "Test output expectation changed from 2 lines to 1 line for tiny banner"
      mechanism: |
        Test in stdlib/REPL/test/repl.jl changed:
          Old: @test REPL.banner(io; short=true) === nothing
               @test countlines(io) == 2
          New: @test REPL.banner(io, :tiny) === nothing
               @test countlines(io) == 1

        The tiny banner (size == 1) is a single line when tagged_commit is true:
          styled"""{bold:{blue:therefore} {magenta:Julia} $VERSION}$commit_date\n"""
      downstream_surfaces:
        - "Tests that check banner output line counts"
      likelihood: "low"
      impact: "low"

  compatibility:
    internal_api:
      - field: "REPL.banner signature"
        change: "Keyword argument `short::Bool` replaced with positional `preferred::Symbol`"
        affected_tools:
          - tool: "REPL customization scripts"
            usage: "Code that called banner(io; short=true) must update to banner(io, :short)"
      - field: "Base.JLOptions().banner numeric values"
        change: "Numeric mapping expanded: 2 now means narrow, 3 means short, 4 means tiny"
        affected_tools:
          - tool: "Launch wrappers"
            usage: "Code checking JLOptions().banner == 2 for short must update to check for 3"
    behavioral:
      - change: "Banner output format completely redesigned"
        description: |
          Visual appearance of startup banner changed significantly.
          New Unicode characters used in banner output.
          Hyperlinks embedded in banner text pointing to docs.julialang.org and pkgdocs.julialang.org.
          displaysize() is called to determine terminal dimensions for banner sizing.
        impact: "visual-only"

  performance:
    compile_time:
      - impact: "Slight increase in REPL precompilation"
        description: |
          14 new precompile statements added for StyledStrings/AnnotatedString handling.
          Functions precompiled include:
          - Base.AnnotatedDisplay.ansi_write
          - Base.all with Tuple{Bool, Bool}
          - Base.get/setindex!/hashindex for Face dictionary lookups
          - Base.print for AnnotatedString
          - REPL.banner with TTY
          ESTIMATED: negligible (<1s) increase in stdlib precompilation time.
    runtime:
      - impact: "Minimal overhead for displaysize() check"
        description: |
          Banner selection now calls displaysize(io) to determine terminal dimensions.
          O(1) operation - single ioctl/console query.
          Logic: all(displaysize(io) .>= (rows, cols)) for various thresholds.
          ESTIMATED: <1ms additional latency at startup.

  risk:
    level: "medium"
    rationale:
      - "Changes are entirely in REPL display code, no compiler internals touched"
      - "PR was REVERTED due to build failure on tagged releases (TAGGED_RELEASE_BANNER bug)"
      - "No type inference, lowering, optimization, or codegen changes"
      - "API break is limited to REPL.banner() function rarely called directly"
      - "Visual-only changes with fallback for small terminals"
      - "Bug only manifests in tagged release builds, not detected during normal development"

  downstream_impact:
    packages: []
    surfaces:
      - "REPL startup display"
      - "CLI --banner option"
      - "Tagged release builds (due to bug)"
    notes: |
      This PR has NO impact on compiler internals or packages like JET, Enzyme,
      or GPUCompiler. It is purely a user-facing REPL display change.

      The only potential breakage is:
      1. Code calling REPL.banner(io; short=true) - must update to banner(io, :short)
      2. Code checking Base.JLOptions().banner numeric values - must update mappings

      CRITICAL: This PR was REVERTED due to a bug on line 1779 where TAGGED_RELEASE_BANNER
      is referenced without the Base. prefix. This causes UndefVarError on tagged release
      builds, manifesting as a precompilation deadlock.

      Revert PRs:
      - PR #59984 reverted on master branch
      - PR #60186 reverted on release-1.13 branch (November 21, 2025)

  open_questions:
    - "Will this feature be re-implemented with the TAGGED_RELEASE_BANNER bug fixed?"
    - "Did StyledStrings precompilation issues mentioned in PR description get fully resolved?"

  recommendations:
    - "No action required for compiler-focused downstream packages"
    - "If using REPL.banner() directly, check for API signature changes if/when this is re-merged"
    - "Consider this PR effectively a no-op when analyzing current Julia due to revert"
    - "Future re-implementation should ensure Base.TAGGED_RELEASE_BANNER with proper prefix"

classification:
  type: "feature"
  compiler_relevant: false
  breaking_change: true
  requires_downstream_action: false

notes: |
  This PR is NOT a compiler change - it modifies only the REPL startup banner display.
  No compiler pipeline components (parsing, lowering, type inference, optimization, codegen)
  are touched. The files modified are:
  - base/client.jl: REPL main entry point (banner option handling, run_std_repl call)
  - src/jloptions.c: CLI argument parsing for --banner (C code)
  - stdlib/REPL/src/REPL.jl: Banner display function with StyledStrings
  - stdlib/REPL/src/precompile.jl: Precompilation hints for AnnotatedString
  - test files: Updated tests for new banner options and output expectations

  This PR was merged October 25, 2025 but was subsequently REVERTED due to a bug:
  Line 1779 uses TAGGED_RELEASE_BANNER without Base. prefix, causing UndefVarError
  on tagged release builds. This error was hidden during precompilation and manifested
  as a deadlock when building official Julia releases.

  The banner() function is called from two locations:
  1. run_std_repl() in base/client.jl:487 - main REPL startup path
  2. run_frontend() in stdlib/REPL/src/REPL.jl:1855 - StreamREPL frontend

  Independent Review Notes (2026-01-21):
  - Verified all code snippets against actual source at merge commit 1ab0e32dd5
  - Confirmed TAGGED_RELEASE_BANNER bug at line 1779 (missing Base. prefix)
  - Found revert PRs: #59984 (master) and #60186 (release-1.13)
  - Traced all banner() call sites in the codebase
  - This is a REPL/UI change with zero compiler impact
