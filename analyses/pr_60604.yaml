schema_version: "1.0"
pr:
  number: 60604
  title: "[JuliaLowering] Workaround `:@macrocall` in doc-expressions"
  url: "https://github.com/JuliaLang/julia/pull/60604"
  author: "topolarity"
  labels: []
  merged_at: "2026-01-09T18:36:49Z"
  merge_commit_sha: "9a85490787e9ac317fe4310ea2182c71bccc7416"
  diff_url: "https://github.com/JuliaLang/julia/pull/60604.diff"
scope:
  files_touched:
    - "JuliaLowering/src/desugaring.jl"
    - "JuliaLowering/test/misc.jl"
    - "test/JuliaLowering_stdlibs.jl"
  components:
    - "JuliaLowering"
  pipeline_stages:
    - "Lowering"
analysis:
  intent:
    summary: "Avoid crashes in JuliaLowering when docstrings precede quoted macrocall expressions (:@macro), leaving full doc! behavior for that form unimplemented."
    issue_links:
      - "https://github.com/JuliaLang/JuliaLowering.jl/issues/132"
  direct_changes:
    - summary: "Detect quoted macrocall shapes in doc expressions and route them through desugaring without trying to bind docs or treat them as function definitions."
      component: "JuliaLowering/desugaring"
      evidence:
        - source: "code"
          path: "JuliaLowering/src/desugaring.jl"
          loc: "4375-4405"
          url: "https://github.com/JuliaLang/julia/blob/9a85490787e9ac317fe4310ea2182c71bccc7416/JuliaLowering/src/desugaring.jl#L4375-L4405"
          snippet: |
            function isquotedmacrocall(ex)
                kind(ex) == K"call" || return false
                numchildren(ex) == 3 || return false
                let (f, ex) = (ex[1], ex[3])
                    kind(f) == K"Value" || return false
                    kind(ex) == K"inert" || return false
                    f.value === interpolate_ast || return false
                    kind(ex[1]) == K"macrocall" || return false
                    return true
                end
            end

            function expand_doc(ctx, ex, docex, mod=ctx.mod)
                if kind(ex) in (K"Identifier", K".")
                    expand_forms_2(ctx, @ast ctx docex [K"call"
                        bind_static_docs!::K"Value"
                        (kind(ex) === K"." ? ex[1] : ctx.mod::K"Value")
                        (kind(ex) === K"." ? ex[2] : ex).name_val::K"Symbol"
                        docex[1]
                        ::K"SourceLocation"(ex)
                        Union{}::K"Value"
                    ])
                elseif isquotedmacrocall(ex)
                    # TODO: implement proper `doc!` support here
                    expand_forms_2(ctx, ex, docex)
                elseif is_eventually_call(ex)
                    expand_function_def(ctx, @ast(ctx, ex, [K"function" ex [K"block"]]),
                                        docex; doc_only=true)
                else
                    expand_forms_2(ctx, ex, docex)
                end
            end
        - source: "rg"
          path: "JuliaLowering/src/desugaring.jl"
          loc: "4387,4474"
          url: "https://github.com/JuliaLang/julia/blob/9a85490787e9ac317fe4310ea2182c71bccc7416/JuliaLowering/src/desugaring.jl#L4387-L4474"
          snippet: |
            $ rg -n "expand_doc" JuliaLowering/src/desugaring.jl
            4387:function expand_doc(ctx, ex, docex, mod=ctx.mod)
            4474:        expand_doc(ctx, ex[2], ex)
    - summary: "Add a JuliaLowering test to ensure a docstring before a quoted macrocall lowers without crashing and yields an Expr."
      component: "JuliaLowering/tests"
      evidence:
        - source: "code"
          path: "JuliaLowering/test/misc.jl"
          loc: "239-244"
          url: "https://github.com/JuliaLang/julia/blob/9a85490787e9ac317fe4310ea2182c71bccc7416/JuliaLowering/test/misc.jl#L239-L244"
          snippet: |
            # doc-strings on macrocalls (punned on quoted macrocall)
            # TODO: implement and test `doc!` support for this
            @test jeval(test_mod, """
                "doc string"
                :@test
            """) isa Expr
    - summary: "Update the list of stdlibs marked incompatible with JuliaLowering precompilation tests (removing InteractiveUtils and revising Test/REPL notes)."
      component: "JuliaLowering/tests"
      evidence:
        - source: "code"
          path: "test/JuliaLowering_stdlibs.jl"
          loc: "3-12"
          url: "https://github.com/JuliaLang/julia/blob/9a85490787e9ac317fe4310ea2182c71bccc7416/test/JuliaLowering_stdlibs.jl#L3-L12"
          snippet: |
            # known precompilation failures under JL
            const INCOMPATIBLE_STDLIBS = String[
                "LibGit2", # op isa Symbol (JuliaLang/JuliaLowering.jl#126)
                "SparseArrays", # type-alias bug (JuliaLang/JuliaLowering.jl#123)
                "TOML", # @invokelatest / QuoteNode bug
                "Test", # nested + destructured args splat (JuliaLang/JuliaLowering.jl#133)
                "REPL", # infinite softscope (in REPL code)
                "Pkg", # depends on TOML
                "SuiteSparse", # depends on SparseArrays
                "LazyArtifacts", # depends on Pkg
            ]
  secondary_effects:
    - effect: "Docstrings immediately preceding quoted macrocalls now flow through regular desugaring instead of doc-binding, preventing the previous crash but leaving doc! behavior unimplemented for that form."
      mechanism: |
        expand_forms_2(ctx, ex, docs=nothing) dispatches K"doc"  [desugaring.jl:4472-4474]
          -> expand_doc(ctx, ex[2], ex)  [desugaring.jl:4387]
          -> isquotedmacrocall(ex) checks for call(Value(interpolate_ast), inert(macrocall), ...)  [desugaring.jl:4375-4383]
          -> expand_forms_2(ctx, ex, docex) to lower the macrocall as a normal expression (docs carried but no bind_static_docs!/doc! path)  [desugaring.jl:4397-4399]
      downstream_surfaces:
        - "Docstring lowering for quoted macrocall syntax (:@macro)"
        - "JuliaLowering docsystem integration (doc! support remains TODO)"
      likelihood: "high"
      impact: "low"
  compatibility:
    internal_api: []
    behavioral:
      - field: "Docstrings on quoted macrocall expressions (:@macro)"
        change: "No longer crash during JuliaLowering desugaring; now lowers to an Expr while skipping doc! handling."
        affected_tools:
          - tool: "JuliaLowering tests"
            usage: "misc.jl asserts docstring + :@test lowers to Expr"
  performance:
    compile_time: []
    runtime: []
  risk:
    level: "low"
    rationale:
      - "Change is confined to docstring desugaring logic with an explicit guard for a narrow syntax form."
      - "Tests added to lock in non-crashing behavior for quoted macrocall docstrings."
  open_questions:
    - "What is the intended doc! behavior for docstrings placed before quoted macrocall syntax (:@macro), and which component should implement it?"
  recommendations:
    - "Implement doc! support for quoted macrocall doc expressions and add targeted tests asserting doc metadata is attached correctly."
