schema_version: "1.0"
pr:
  number: 60246
  title: "Don't introduce a block around `y` in parsing `x' = y`"
  url: "https://github.com/JuliaLang/julia/pull/60246"
  author: "mlechu"
  labels:
    - "parser"
    - "backport 1.12"
    - "backport 1.13"
  merged_at: "2025-11-25T23:20:50Z"
  merge_commit_sha: "2bd75bbe1d0b0cb293f59c2186a7d6a23b305c71"
  diff_url: "https://github.com/JuliaLang/julia/pull/60246.diff"
scope:
  files_touched:
    - "JuliaSyntax/src/integration/expr.jl"
    - "JuliaSyntax/test/expr.jl"
  components:
    - "JuliaSyntax"
  pipeline_stages:
    - "Parsing"
analysis:
  intent:
    summary: "Restore <=1.11 Expr parsing for postfix-quote short-form assignments so `x' = y` does not wrap the RHS in a block, matching historical Expr/flisp behavior and avoiding extra LineNumberNode insertion."
    issue_links:
      - "https://github.com/JuliaLang/julia/issues/59911"
  direct_changes:
    - summary: >-
        Short-form function parsing now skips wrapping the RHS in `Expr(:block, ...)`
        when the LHS is a postfix quote (`Expr(Symbol("'"), ...)`), preserving the
        simpler `Expr(:(=), Expr(Symbol("'"), x), y)` shape.
      component: "JuliaSyntax Expr integration"
      evidence:
        - source: "code"
          path: "JuliaSyntax/src/integration/expr.jl"
          loc: "528-536"
          url: "https://github.com/JuliaLang/julia/blob/2bd75bbe1d0b0cb293f59c2186a7d6a23b305c71/JuliaSyntax/src/integration/expr.jl#L528-L536"
          snippet: |
            elseif k == K"function"
                if length(args) > 1
                    if has_flags(nodehead, SHORT_FORM_FUNCTION_FLAG)
                        a1 = args[1]
                        a2 = args[2]
                        if !@isexpr(a2, :block) && !@isexpr(a1, Symbol("'"))
                            args[2] = Expr(:block, a2)
                        end
                        retexpr.head = :(=)
    - summary: >-
        Added a test asserting that `x' = 1` parses to a plain
        `Expr(:(=), Expr(Symbol("'"), :x), 1)` without a block wrapper.
      component: "JuliaSyntax tests"
      evidence:
        - source: "test"
          path: "JuliaSyntax/test/expr.jl"
          loc: "272-276"
          url: "https://github.com/JuliaLang/julia/blob/2bd75bbe1d0b0cb293f59c2186a7d6a23b305c71/JuliaSyntax/test/expr.jl#L272-L276"
          snippet: |
            # short-form postfix function shouldn't introduce a block
            @test parsestmt("x' = 1") ==
                Expr(:(=),
                     Expr(Symbol("'"), :x),
                     1)
  secondary_effects:
    - effect: "`x' = y` no longer produces an `Expr(:block, LineNumberNode, y)` RHS when round-tripping SyntaxNode -> Expr; tooling that expected a block+LineNumberNode for short-form functions will see a simpler RHS." 
      mechanism: |
        node_to_expr(cursor, ...)  [JuliaSyntax/src/integration/expr.jl:225-299]
          -> parseargs!(retexpr, ...)  [JuliaSyntax/src/integration/expr.jl:200-215]
          -> _node_to_expr(retexpr, ...)  [JuliaSyntax/src/integration/expr.jl:319-536]
            when k == K"function" and SHORT_FORM_FUNCTION_FLAG is set
            and a1 is Expr(Symbol("'"), ...), the RHS is NOT wrapped in Expr(:block, ...)
      downstream_surfaces:
        - "JuliaSyntax.node_to_expr output consumed by JuliaLowering (comment notes extension)"
        - "Macro and tooling code that inspects short-form function RHS for LineNumberNode placement"
      likelihood: "medium"
      impact: "low"
  compatibility:
    internal_api:
      - field: "JuliaSyntax.node_to_expr(::SyntaxNode, ...)"
        change: "For postfix-quote short-form functions, RHS stays as the raw expression instead of a `Expr(:block, ...)` wrapper."
        affected_tools:
          - tool: "JuliaLowering"
            usage: "JuliaLowering extends `node_to_expr(::SyntaxTree, ...)`, relying on JuliaSyntax Expr shapes for downstream lowering."
    behavioral:
      - change: "Expr shape for `x' = y` now matches <=1.11 (no block wrapper) which can affect macro pattern matches on short-form functions."
        impact: "low"
  performance:
    compile_time:
      - impact: "ESTIMATED: negligible; a single extra predicate check in short-form function handling."
    runtime:
      - impact: "No runtime impact; change is limited to parsing/Expr construction."
  risk:
    level: "low"
    rationale:
      - "Localized JuliaSyntax Expr conversion change with explicit regression test for postfix-quote short-form assignment."
  open_questions:
    - "Should similar postfix operators or syntactic sugar (other than `'`) also avoid RHS block-wrapping for short-form assignments?"
  recommendations:
    - "Notify downstream tooling that matches `Expr(:(=), lhs, Expr(:block, ...))` for short-form functions to also accept a non-block RHS when lhs is postfix-quote."
