schema_version: 1
package: Mooncake.jl
description: Mooncake compiler dependency map for predicting Julia compiler change impact

capabilities:
  - id: opaque_closure
    title: OpaqueClosure generation
    fragility: critical
    description: |
      Mooncake generates OpaqueClosures from IR to create differentiated functions.
      World-age mismatches, signature changes, and codegen modifications break Mooncake.
    julia_files:
      - Compiler/src/opaque_closure.jl
      - base/opaque_closure.jl
      - src/opaque_closure.c
    mooncake_files:
      - src/utils.jl
      - src/rules/misty_closures.jl
      - src/interpreter/forward_mode.jl
      - src/interpreter/reverse_mode.jl
      - ext/MooncakeFunctionWrappersExt.jl
    known_issues:
      - World-age mismatch when methods defined between IR generation and OpaqueClosure creation
      - Signature validation changes in 1.12
      - DebugInfo/linetable format changes in 1.12

  - id: abstract_interpreter
    title: AbstractInterpreter hooks
    fragility: high
    description: |
      MooncakeInterpreter extends CC.AbstractInterpreter for custom type inference.
      API changes to inference params, method tables, or caching break Mooncake.
    julia_files:
      - Compiler/src/types.jl
      - Compiler/src/abstractinterpretation.jl
      - Compiler/src/inferencestate.jl
      - Compiler/src/typeinfer.jl
      - Compiler/src/methodtable.jl
      - Compiler/src/stmtinfo.jl
      - Compiler/src/typelattice.jl
      - Compiler/src/abstractlattice.jl
      - Compiler/src/typeutils.jl
      - Compiler/src/utilities.jl
      - Compiler/src/tfuncs.jl
      - Compiler/src/cicache.jl
      - Compiler/src/effects.jl
      - Compiler/src/ssair/irinterp.jl
    mooncake_files:
      - src/interpreter/abstract_interpretation.jl
      - src/interpreter/patch_for_319.jl

  - id: ircode_cfg
    title: IRCode and CFG manipulation
    fragility: high
    description: |
      Mooncake heavily manipulates IRCode, basic blocks, and control flow graphs.
      Changes to IR structure, instruction encoding, or CFG representation break AD.
    julia_files:
      - Compiler/src/ssair/ir.jl
      - Compiler/src/ssair/basicblock.jl
      - Compiler/src/ssair/verify.jl
      - Compiler/src/ssair/show.jl
      - Compiler/src/ssair/slot2ssa.jl
      - Compiler/src/ssair/domtree.jl
    mooncake_files:
      - src/interpreter/ir_utils.jl
      - src/interpreter/ir_normalisation.jl
      - src/interpreter/bbcode.jl
      - src/interpreter/forward_mode.jl
      - src/interpreter/reverse_mode.jl

  - id: optimization
    title: Optimization passes
    fragility: medium
    description: |
      Mooncake uses compiler optimization passes (inlining, SROA, ADCE).
      Pass API changes or behavioral changes affect AD correctness and performance.
    julia_files:
      - Compiler/src/optimize.jl
      - Compiler/src/ssair/inlining.jl
      - Compiler/src/ssair/passes.jl
    mooncake_files:
      - src/interpreter/ir_utils.jl
      - src/interpreter/abstract_interpretation.jl

anchors:
  # OpaqueClosure anchors (Critical)
  - id: base_generate_opaque_closure
    capability: opaque_closure
    kind: call
    target: Base.Experimental.generate_opaque_closure
    files: [src/utils.jl]

  - id: cc_compute_ir_rettype
    capability: opaque_closure
    kind: call
    target: CC.compute_ir_rettype
    files: [src/utils.jl]

  - id: cc_compute_oc_signature
    capability: opaque_closure
    kind: call
    target: CC.compute_oc_signature
    files: [src/utils.jl]

  # AbstractInterpreter anchors (High)
  - id: cc_abstract_interpreter
    capability: abstract_interpreter
    kind: type
    target: CC.AbstractInterpreter
    files: [src/interpreter/abstract_interpretation.jl, src/interpreter/ir_utils.jl, src/interpreter/patch_for_319.jl]

  - id: cc_inference_params
    capability: abstract_interpreter
    kind: type
    target: CC.InferenceParams
    files: [src/interpreter/abstract_interpretation.jl]

  - id: cc_optimization_params
    capability: abstract_interpreter
    kind: type
    target: CC.OptimizationParams
    files: [src/interpreter/abstract_interpretation.jl]

  - id: cc_inference_result
    capability: abstract_interpreter
    kind: type
    target: CC.InferenceResult
    files: [src/interpreter/abstract_interpretation.jl]

  - id: cc_method_table
    capability: abstract_interpreter
    kind: call
    target: CC.method_table
    files: [src/interpreter/abstract_interpretation.jl]

  - id: cc_overlay_method_table
    capability: abstract_interpreter
    kind: call
    target: CC.OverlayMethodTable
    files: [src/interpreter/abstract_interpretation.jl]

  - id: cc_typeinf_type
    capability: abstract_interpreter
    kind: call
    target: CC.typeinf_type
    files: [src/interpreter/abstract_interpretation.jl]

  - id: cc_typeinf_ircode
    capability: abstract_interpreter
    kind: call
    target: CC.typeinf_ircode
    files: [src/interpreter/ir_utils.jl]

  - id: cc_abstract_call_gf_by_type
    capability: abstract_interpreter
    kind: call
    target: Core.Compiler.abstract_call_gf_by_type
    files: [src/interpreter/abstract_interpretation.jl]

  - id: cc_inlining_policy
    capability: abstract_interpreter
    kind: call
    target: CC.inlining_policy
    files: [src/interpreter/abstract_interpretation.jl]

  # IRCode/CFG anchors (High)
  - id: cc_ircode
    capability: ircode_cfg
    kind: type
    target: Core.Compiler.IRCode
    files: [src/Mooncake.jl, src/interpreter/ir_utils.jl, src/interpreter/bbcode.jl, src/interpreter/forward_mode.jl]

  - id: cc_instruction_stream
    capability: ircode_cfg
    kind: type
    target: CC.InstructionStream
    files: [src/interpreter/ir_utils.jl, src/interpreter/bbcode.jl]

  - id: cc_cfg
    capability: ircode_cfg
    kind: type
    target: Core.Compiler.CFG
    files: [src/interpreter/bbcode.jl]

  - id: cc_basic_block
    capability: ircode_cfg
    kind: type
    target: Core.Compiler.BasicBlock
    files: [src/interpreter/bbcode.jl]

  - id: cc_compute_basic_blocks
    capability: ircode_cfg
    kind: call
    target: CC.compute_basic_blocks
    files: [src/interpreter/ir_utils.jl]

  - id: cc_verify_ir
    capability: ircode_cfg
    kind: call
    target: CC.verify_ir
    files: [src/interpreter/ir_utils.jl, src/interpreter/ir_normalisation.jl, src/interpreter/forward_mode.jl]

  - id: cc_compact
    capability: ircode_cfg
    kind: call
    target: CC.compact!
    files: [src/interpreter/ir_utils.jl, src/interpreter/forward_mode.jl]

  # Optimization anchors (Medium)
  - id: cc_inlining_state
    capability: optimization
    kind: call
    target: CC.InliningState
    files: [src/interpreter/ir_utils.jl]

  - id: cc_ssa_inlining_pass
    capability: optimization
    kind: call
    target: CC.ssa_inlining_pass!
    files: [src/interpreter/ir_utils.jl]

  - id: cc_sroa_pass
    capability: optimization
    kind: call
    target: CC.sroa_pass!
    files: [src/interpreter/ir_utils.jl]

  - id: cc_adce_pass
    capability: optimization
    kind: call
    target: CC.adce_pass!
    files: [src/interpreter/ir_utils.jl]

  - id: cc_ir_to_codeinf
    capability: optimization
    kind: call
    target: CC.ir_to_codeinf!
    files: [src/utils.jl]

historical_breakage_patterns:
  - pattern: OpaqueClosure world-age mismatch
    julia_versions: [1.12+]
    frequency: recurring
    mitigation: Use IR's valid_worlds.max_world

  - pattern: DebugInfoStream vs LineInfoNode
    julia_versions: [1.12]
    frequency: one-time
    mitigation: Version guard with @static

  - pattern: Memory type (vs Array)
    julia_versions: [1.11+]
    frequency: one-time
    mitigation: Conditional rules and type handling

  - pattern: InstructionStream field name (.inst vs .stmt)
    julia_versions: [1.11]
    frequency: one-time
    mitigation: Version guard

  - pattern: adce_pass! return value change
    julia_versions: [1.11]
    frequency: one-time
    mitigation: Version guard
