# PR #60246: Don't introduce a block around `y` in parsing `x' = y`

## Metadata

- **Author**: mlechu
- **URL**: https://github.com/JuliaLang/julia/pull/60246
- **Merged**: 2025-11-25 23:20 UTC
- **Labels**: `parser`, `backport 1.12`, `backport 1.13`
- **Diff**: https://github.com/JuliaLang/julia/pull/60246.diff

## Scope

### Files Touched
- `JuliaSyntax/src/integration/expr.jl`
- `JuliaSyntax/test/expr.jl`

### Components
- JuliaSyntax

### Pipeline Stages
- Parsing

## Analysis

### Intent

Restore <=1.11 Expr parsing for postfix-quote short-form assignments so `x' = y` does not wrap the RHS in a block, matching historical Expr/flisp behavior and avoiding extra LineNumberNode insertion.

**Related Issues:**
- https://github.com/JuliaLang/julia/issues/59911

### Direct Changes

#### 1. Short-form function parsing now skips wrapping the RHS in `Expr(:block, ...)` when the LHS is a postfix quote (`Expr(Symbol("'"), ...)`), preserving the simpler `Expr(:(=), Expr(Symbol("'"), x), y)` shape.

**Component**: JuliaSyntax Expr integration

<details>
<summary>Evidence</summary>

**JuliaSyntax/src/integration/expr.jl:528-536**
[View on GitHub](https://github.com/JuliaLang/julia/blob/2bd75bbe1d0b0cb293f59c2186a7d6a23b305c71/JuliaSyntax/src/integration/expr.jl#L528-L536)
```julia
elseif k == K"function"
    if length(args) > 1
        if has_flags(nodehead, SHORT_FORM_FUNCTION_FLAG)
            a1 = args[1]
            a2 = args[2]
            if !@isexpr(a2, :block) && !@isexpr(a1, Symbol("'"))
                args[2] = Expr(:block, a2)
            end
            retexpr.head = :(=)
```

</details>

#### 2. Added a test asserting that `x' = 1` parses to a plain `Expr(:(=), Expr(Symbol("'"), :x), 1)` without a block wrapper.

**Component**: JuliaSyntax tests

<details>
<summary>Evidence</summary>

**JuliaSyntax/test/expr.jl:272-276**
[View on GitHub](https://github.com/JuliaLang/julia/blob/2bd75bbe1d0b0cb293f59c2186a7d6a23b305c71/JuliaSyntax/test/expr.jl#L272-L276)
```julia
# short-form postfix function shouldn't introduce a block
@test parsestmt("x' = 1") ==
    Expr(:(=),
         Expr(Symbol("'"), :x),
         1)
```

</details>

### Secondary Effects

#### `x' = y` no longer produces an `Expr(:block, LineNumberNode, y)` RHS when round-tripping SyntaxNode -> Expr; tooling that expected a block+LineNumberNode for short-form functions will see a simpler RHS.

**Likelihood**: medium | **Impact**: low

<details>
<summary>Mechanism</summary>

```
node_to_expr(cursor, ...)  [JuliaSyntax/src/integration/expr.jl:225-299]
  -> parseargs!(retexpr, ...)  [JuliaSyntax/src/integration/expr.jl:200-215]
  -> _node_to_expr(retexpr, ...)  [JuliaSyntax/src/integration/expr.jl:319-536]
    when k == K"function" and SHORT_FORM_FUNCTION_FLAG is set
    and a1 is Expr(Symbol("'"), ...), the RHS is NOT wrapped in Expr(:block, ...)
```
</details>

**Downstream Surfaces:**
- JuliaSyntax.node_to_expr output consumed by JuliaLowering (comment notes extension)
- Macro and tooling code that inspects short-form function RHS for LineNumberNode placement

### Compatibility

#### Internal API Changes
- **JuliaSyntax.node_to_expr(::SyntaxNode, ...)**: For postfix-quote short-form functions, RHS stays as the raw expression instead of a `Expr(:block, ...)` wrapper.

#### Behavioral Changes
- Expr shape for `x' = y` now matches <=1.11 (no block wrapper) which can affect macro pattern matches on short-form functions. *(Impact: low)*

### Performance

**Compile Time:**
- ESTIMATED: negligible; a single extra predicate check in short-form function handling.

**Runtime:**
- No runtime impact; change is limited to parsing/Expr construction.

### Risk Assessment

**Level**: low

**Rationale:**
- Localized JuliaSyntax Expr conversion change with explicit regression test for postfix-quote short-form assignment.

### Recommendations

- Notify downstream tooling that matches `Expr(:(=), lhs, Expr(:block, ...))` for short-form functions to also accept a non-block RHS when lhs is postfix-quote.
