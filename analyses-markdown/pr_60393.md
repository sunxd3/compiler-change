# PR #60393: type assert `src.edges` in a place where it is used as a an argument to `append!`

## Metadata

- **Author**: KristofferC
- **URL**: https://github.com/JuliaLang/julia/pull/60393
- **Merged**: 2025-12-17 11:21 UTC
- **Diff**: https://github.com/JuliaLang/julia/pull/60393.diff

## Scope

### Files Touched
- `Compiler/src/typeinfer.jl`

### Components
- Compiler.TypeInference

### Pipeline Stages
- TypeInference
- Backedges

## Analysis

### Intent

Add a concrete type assertion for `CodeInfo.edges` when building backedge lists so inference sees a concrete union and avoids type-instability noise (notably in SnoopCompile reports).

### Direct Changes

#### 1. Constrain `sv.src.edges` to `Union{Nothing, SimpleVector, Vector{Any}}` before passing it to `append!` in `compute_edges!` so inference can avoid type-unstable edges handling.

**Component**: Compiler/src/typeinfer.jl (compute_edges!)

<details>
<summary>Evidence</summary>

**Compiler/src/typeinfer.jl:815-824**
[View on GitHub](https://github.com/JuliaLang/julia/blob/aa2be168da5b3b01acabe483353b00cd6090261e/Compiler/src/typeinfer.jl#L815-L824)
```julia
function compute_edges!(sv::InferenceState)
    edges = sv.edges
    for i in 1:length(sv.stmt_info)
        add_edges!(edges, sv.stmt_info[i])
    end
    user_edges = sv.src.edges::Union{Nothing, SimpleVector, Vector{Any}}
    if user_edges !== nothing && user_edges !== empty_edges
        append!(edges, user_edges)
    end
    nothing
end
```

</details>

### Secondary Effects

#### Reduces type-instability noise in inference tooling (e.g., SnoopCompile) by forcing a concrete union type for `user_edges` before `append!` is invoked.

**Likelihood**: medium | **Impact**: low

<details>
<summary>Mechanism</summary>

```
finishinfer!(...)  [Compiler/src/typeinfer.jl:640-668]
  -> compute_edges!(sv)  [Compiler/src/typeinfer.jl:815-824]
    user_edges = sv.src.edges::Union{Nothing, SimpleVector, Vector{Any}}
    append!(edges, user_edges)
```
</details>

**Downstream Surfaces:**
- Inference diagnostics (type-instability reports)
- SnoopCompile backedge noise

### Compatibility

#### Internal API Changes
- **CodeInfo.edges / InferenceState.src.edges**: `compute_edges!` now asserts edges are `Union{Nothing, SimpleVector, Vector{Any}}` before appending.

#### Behavioral Changes
- If `CodeInfo.edges` is set to a non-matching type, `compute_edges!` will now throw a `TypeError` rather than accepting the value.

### Performance

**Compile Time:**
- ESTIMATED: minor reduction in inference-time type instability from `append!` on `user_edges` due to the concrete union assertion.

**Runtime:**
- No runtime behavior changes expected (inference-only code path).

### Risk Assessment

**Level**: low

**Rationale:**
- Change is a local type assertion inside inference; only affects invalid `edges` types.
- No changes to codegen or optimization decisions beyond inference diagnostics.

### Recommendations

- Downstream tooling that constructs or mutates `CodeInfo.edges` should ensure it uses `nothing`, `SimpleVector`, or `Vector{Any}` before invoking inference APIs.
