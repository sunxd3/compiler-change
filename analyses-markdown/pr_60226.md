# PR #60226: [JuliaLowering] Fix handling of unnamed args in `@generated` functions

## Metadata

- **Author**: topolarity
- **URL**: https://github.com/JuliaLang/julia/pull/60226
- **Merged**: 2025-11-24 23:23 UTC
- **Labels**: `compiler:lowering`
- **Diff**: https://github.com/JuliaLang/julia/pull/60226.diff

## Scope

### Files Touched
- `JuliaLowering/src/desugaring.jl`
- `JuliaLowering/src/runtime.jl`
- `JuliaLowering/test/functions.jl`

### Components
- JuliaLowering

### Pipeline Stages
- MacroExpansion
- Lowering
- ScopeResolution

## Analysis

### Intent

Ensure JuliaLowering can lower @generated methods that include unnamed arguments by synthesizing stable, unique stub names and preserving source references for non-syntax return values.

### Direct Changes

#### 1. Introduce a helper that assigns deterministic placeholder names ("#arg{i}#") to unnamed arguments (BindingId) so generated-function stubs avoid repeated "#unused#" names.

**Component**: JuliaLowering/src/desugaring.jl

<details>
<summary>Evidence</summary>

**JuliaLowering/src/desugaring.jl:2537-2576**
[View on GitHub](https://github.com/JuliaLang/julia/blob/47c627152131e11562fef655d4d329c3fb001300/JuliaLowering/src/desugaring.jl#L2537-L2576)
```julia
function stub_argname(n::SyntaxTree, i)
    if kind(n) == K"Identifier"
        return n.name_val::String
    elseif kind(n) == K"BindingId"
        # flisp lowering calls these unnamed arguments "#unused#", but JL does
        # not accept that as a repeated argument name
        return "#arg" * string(i) * "#"
    else @assert false "Unexpected argument kind: $(kind(n))" end
end
[K"call"
    "svec"::K"core"
    "#self#"::K"Symbol"
    (stub_argname(n,i)::K"Symbol"(n) for (i,n) in enumerate(arg_names[2:end]))...
]
```

</details>

#### 2. Preserve the generated function stub source reference when the generator returns a non-SyntaxTree value, improving provenance for later macro expansion and lowering steps.

**Component**: JuliaLowering/src/runtime.jl

<details>
<summary>Evidence</summary>

**JuliaLowering/src/runtime.jl:332-343**
[View on GitHub](https://github.com/JuliaLang/julia/blob/47c627152131e11562fef655d4d329c3fb001300/JuliaLowering/src/runtime.jl#L332-L343)
```julia
mctx = MacroContext(syntax_graph(ctx1), g.srcref, layer, false)
ex0 = g.gen(mctx, args...)
if ex0 isa SyntaxTree
    if !is_compatible_graph(ctx1, ex0)
        ex0 = copy_ast(ctx1, ex0)
    end
else
    ex0 = @ast ctx1 g.srcref ex0::K"Value"
end
```

</details>

#### 3. Add a regression test ensuring generated functions with unnamed arguments execute correctly under JuliaLowering.

**Component**: JuliaLowering/test/functions.jl

<details>
<summary>Evidence</summary>

**JuliaLowering/test/functions.jl:503-524**
[View on GitHub](https://github.com/JuliaLang/julia/blob/47c627152131e11562fef655d4d329c3fb001300/JuliaLowering/test/functions.jl#L503-L524)
```julia
@testset "Generated functions" begin
    @test JuliaLowering.include_string(test_mod, """
    begin
        @generated function f_gen_unnamed_args(::Type{T}, y, ::Type{U}) where {T, U}
            return (T, y, U)
        end

        f_gen_unnamed_args(Int, UInt8(3), Float64)
    end
    """) == (Int, UInt8, Float64)
end
```

</details>

### Secondary Effects

#### Unnamed arguments in @generated methods no longer collide on "#unused#" and can be lowered without duplicate-argument errors.

**Likelihood**: high | **Impact**: medium

<details>
<summary>Mechanism</summary>

```
expand_function_generator(...)  [desugaring.jl:2490]
  -> stub_argname(n,i)  [desugaring.jl:2537-2544]
    returns "#arg{i}#" for BindingId unnamed args
  -> GeneratedFunctionStub(argnames = svec("#self#", stub_argname(...)))  [desugaring.jl:2571-2576]
  -> GeneratedFunctionStub runtime uses g.argnames to synthesize lambda binders
     in lowering scope resolution  [runtime.jl:354-360]
```
</details>

**Downstream Surfaces:**
- @generated functions in Base/stdlib and packages that include unnamed Type parameters
- JuliaLowering users that precompile stdlibs (e.g., Dates)

### Compatibility

#### Internal API Changes
- **GeneratedFunctionStub.argnames**: Unnamed arguments now appear as synthesized "#arg{i}#" placeholders instead of repeated "#unused#".

#### Behavioral Changes
- Generated functions with unnamed arguments are accepted by JuliaLowering and evaluate correctly.

### Performance

### Risk Assessment

**Level**: low

**Rationale:**
- Change is localized to generated-function stub argument naming and source provenance in JuliaLowering.
- New test exercises the previously failing case of unnamed arguments in @generated methods.

### Recommendations

- Downstream tooling that inspects GeneratedFunctionStub.argnames should tolerate synthesized "#arg{i}#" placeholders for unnamed arguments.
- If diagnostic tooling depends on source locations for generated code, validate that g.srcref is now propagated for non-SyntaxTree returns.
