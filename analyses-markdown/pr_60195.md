# PR #60195: Fix `remove-argument-side-effects` with keyword call

## Metadata

- **Author**: mlechu
- **URL**: https://github.com/JuliaLang/julia/pull/60195
- **Merged**: 2025-11-22 04:18 UTC
- **Labels**: `compiler:lowering`, `bugfix`, `backport 1.13`
- **Diff**: https://github.com/JuliaLang/julia/pull/60195.diff

## Scope

### Files Touched
- `JuliaLowering/src/desugaring.jl`
- `JuliaLowering/test/assignments.jl`
- `src/julia-syntax.scm`
- `test/syntax.jl`

### Components
- JuliaLowering
- JuliaSyntax

### Pipeline Stages
- Lowering
- Parsing

## Analysis

### Intent

Fix keyword-call handling in remove-argument-side-effects so keyword arguments inside a parameters block are made single-evaluation-safe, aligning the Scheme and JuliaLowering implementations and addressing LHS broadcast/update bugs.

**Related Issues:**
- https://github.com/JuliaLang/julia/issues/60152

### Direct Changes

#### 1. JuliaLowering: _arg_to_temp now recurses into K"parameters" so keyword arguments in parameters blocks are processed for single-evaluation, and kw '=' arguments route through _arg_to_temp to avoid duplicating side effects.

**Component**: JuliaLowering

<details>
<summary>Evidence</summary>

**JuliaLowering/src/desugaring.jl:535-546**
[View on GitHub](https://github.com/JuliaLang/julia/blob/e49a23d429f7d2bba0edf4973f568735ef50d3a2/JuliaLowering/src/desugaring.jl#L535-L546)
```julia
function _arg_to_temp(ctx, stmts, ex, eq_is_kw=false)
    k = kind(ex)
    if is_effect_free(ex)
        ex
    elseif k == K"..."
        @ast ctx ex [k _arg_to_temp(ctx, stmts, ex[1])]
    elseif k == K"=" && eq_is_kw
        @ast ctx ex [K"=" ex[1] _arg_to_temp(ctx, stmts, ex[2], false)]
    elseif k == K"parameters"
        mapchildren(ctx, ex) do e
            _arg_to_temp(ctx, stmts, e, true)
        end
    else
        emit_assign_tmp(stmts, ctx, ex)
    end
end
```

</details>

#### 2. Scheme lowering: remove-argument-side-effects now treats 'parameters' lists explicitly and continues to transform kw values via arg-to-temp, ensuring kwcall arguments are single-evaluation-safe in the legacy lowering path.

**Component**: JuliaSyntax

<details>
<summary>Evidence</summary>

**src/julia-syntax.scm:1807-1826**
[View on GitHub](https://github.com/JuliaLang/julia/blob/e49a23d429f7d2bba0edf4973f568735ef50d3a2/src/julia-syntax.scm#L1807-L1826)
```julia
(define (remove-argument-side-effects e)
  (if (not (pair? e))
      (cons e '())
      (let ((a '()))
        (define (arg-to-temp x)
          (cond ((effect-free? x) x)
                ((eq? (car x) '...)
                 `(... ,(arg-to-temp (cadr x))))
                ((eq? (car x) 'kw)
                 `(kw ,(cadr x) ,(arg-to-temp (caddr x))))
                ((eq? (car x) 'parameters)
                 `(parameters ,@(map arg-to-temp (cdr x))))
                (else
                 (let ((g (make-ssavalue)))
                   (begin (set! a (cons `(= ,g ,x) a))
                          g)))))
        (if (eq? (car e) 'let)
          (cons (arg-to-temp e) (reverse a))
          (cons (cons (car e) (map arg-to-temp (cdr e)))
                (reverse a))))))
```

</details>

### Secondary Effects

#### Broadcast/update assignment LHS kwcall arguments are now evaluated exactly once, preventing repeated side effects in both lowering implementations.

**Likelihood**: high | **Impact**: medium

<details>
<summary>Mechanism</summary>

```
remove_argument_side_effects(ctx, stmts, ex)  [JuliaLowering/src/desugaring.jl:559-573]
  -> _arg_to_temp(ctx, stmts, e, eq_is_kw)  [JuliaLowering/src/desugaring.jl:535-546]
     - handles K"parameters" by mapping _arg_to_temp(..., true) over children
  -> expand_update_operator uses remove_argument_side_effects on lhs  [JuliaLowering/src/desugaring.jl:1400-1427]
```
</details>

**Downstream Surfaces:**
- broadcasted update lowering (.op=)
- kwcall LHS in assignments

#### Legacy syntax lowering for keyword calls avoids duplicating side-effectful kw arguments inside parameters blocks.

**Likelihood**: high | **Impact**: low

<details>
<summary>Mechanism</summary>

```
lower-kw-call f args  [src/julia-syntax.scm:1828-1834]
  -> remove-argument-side-effects  [src/julia-syntax.scm:1807-1826]
     -> arg-to-temp handles (parameters ...) and (kw name value)
```
</details>

**Downstream Surfaces:**
- syntax-lowered kw calls used before JuliaLowering is enabled

### Compatibility

#### Behavioral Changes
- Keyword-call LHS side effects inside parameters/kw blocks are no longer duplicated during lowering; code relying on multiple evaluations will now run once.

### Performance

**Compile Time:**
- ESTIMATED: adds a mapchildren traversal over parameters nodes when present; O(n) in number of kw arguments.

### Risk Assessment

**Level**: low

**Rationale:**
- Change is localized to lowering of argument side effects and backed by new tests for kwcall LHS behavior.

### Recommendations

- Downstream tooling that inspects lowered LHS kwcalls (e.g., macro-based broadcast transformations) should add coverage for parameters blocks to ensure single-evaluation semantics align with this fix.
