# PR #60587: [JuliaLowering] Mark internal lowering bindings as is_internal

## Metadata

- **Author**: aviatesk
- **URL**: https://github.com/JuliaLang/julia/pull/60587
- **Merged**: 2026-01-08 15:25 UTC
- **Labels**: `compiler:lowering`, `JuliaLowering`
- **Diff**: https://github.com/JuliaLang/julia/pull/60587.diff

## Scope

### Files Touched
- `JuliaLowering/src/desugaring.jl`
- `JuliaLowering/src/scope_analysis.jl`

### Components
- JuliaLowering

### Pipeline Stages
- Lowering
- ScopeAnalysis

## Analysis

### Intent

Mark keyword-function reflection locals as internal so tooling (e.g., language servers) can ignore compiler-generated bindings during scope analysis.

### Direct Changes

#### 1. Keyword-function desugaring now tags reflection-only local declarations with CompileHints(:is_internal, true).

**Component**: JuliaLowering/src/desugaring.jl

<details>
<summary>Evidence</summary>

**JuliaLowering/src/desugaring.jl:2795-2801**
[View on GitHub](https://github.com/JuliaLang/julia/blob/c2647e99afdb598f64ce7859ed50761b61a5a9f3/JuliaLowering/src/desugaring.jl#L2795-L2801)
```julia
if use_ssa_kw_temps
    kw_val_stmts = SyntaxList(ctx)
    for n in kw_names
        # If not using slots for the keyword argument values, still declare
        # them for reflection purposes.
        push!(kw_val_stmts, @ast ctx n [K"local"(meta=CompileHints(:is_internal, true)) n])
    end
    kw_val_vars = SyntaxList(ctx)
```

</details>

#### 2. Scope analysis treats local declarations carrying :is_internal metadata as internal bindings by bypassing maybe_declare_in_scope! and forcing declare_in_scope!(; is_internal=true).

**Component**: JuliaLowering/src/scope_analysis.jl

<details>
<summary>Evidence</summary>

**JuliaLowering/src/scope_analysis.jl:192-201**
[View on GitHub](https://github.com/JuliaLang/julia/blob/c2647e99afdb598f64ce7859ed50761b61a5a9f3/JuliaLowering/src/scope_analysis.jl#L192-L201)
```julia
function _find_scope_decls!(ctx, scope, ex)
    k = kind(ex)
    if k === K"local" && kind(ex[1]) === K"Identifier"
        var_k = getmeta(ex, :is_destructured_arg, false) ?
            :destructured_arg : :local
        if getmeta(ex, :is_internal, false)
            declare_in_scope!(ctx, scope, ex[1], var_k; is_internal=true)
        else
            maybe_declare_in_scope!(ctx, scope, ex[1], var_k)
        end
```

</details>

### Secondary Effects

#### @locals extension skips keyword-reflection locals marked internal, reducing noise for tooling that inspects local variable tables.

**Likelihood**: high | **Impact**: low

<details>
<summary>Mechanism</summary>

```
keyword_function_defs(...)  [desugaring.jl:2795-2801]
  emits K"local" with CompileHints(:is_internal, true)
-> _find_scope_decls!(ctx, scope, ex)  [scope_analysis.jl:192-201]
  detects :is_internal metadata and calls declare_in_scope!(; is_internal=true)
-> @locals extension in scope analysis  [scope_analysis.jl:440-454]
  filters binfo.is_internal when building locals dictionary
```
</details>

**Downstream Surfaces:**
- @locals macro expansion (Base.@locals in lowering IR)
- Tooling that consumes BindingInfo tables from JuliaLowering

### Compatibility

#### Internal API Changes
- **BindingInfo.is_internal**: Now set for keyword-function reflection locals created during desugaring; consumers should filter these if they previously expected only user-defined locals.

#### Behavioral Changes
- @locals results omit compiler-internal keyword reflection bindings (treated like globals).

### Performance

**Compile Time:**
- ESTIMATED: one extra metadata check in _find_scope_decls! when encountering local declarations; negligible (<1% of lowering time).

**Runtime:**
- No runtime codegen changes; metadata only affects scope tables and @locals output during lowering.

### Risk Assessment

**Level**: low

**Rationale:**
- Change is limited to metadata propagation and scope table filtering in JuliaLowering; no changes to runtime semantics or codegen.
- Behavioral impact confined to tooling that inspects locals or binding info.

### Recommendations

- Tooling that inspects BindingInfo or @locals output should ignore bindings with is_internal=true (especially keyword-function reflection locals).
