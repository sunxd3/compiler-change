# PR #60602: [JuliaLowering] Fix-up always-defined check in `is_valid_body_ir_argument`

## Metadata

- **Author**: topolarity
- **URL**: https://github.com/JuliaLang/julia/pull/60602
- **Merged**: 2026-01-08 18:52 UTC
- **Diff**: https://github.com/JuliaLang/julia/pull/60602.diff

## Scope

### Files Touched
- `JuliaLowering/src/linear_ir.jl`
- `JuliaLowering/test/assignments_ir.jl`
- `JuliaLowering/test/closures_ir.jl`
- `JuliaLowering/test/decls_ir.jl`
- `JuliaLowering/test/typedefs_ir.jl`

### Components
- JuliaLowering

### Pipeline Stages
- Lowering
- LinearIR

## Analysis

### Intent

Restore the flisp behavior that treats lambda arguments as always-defined for body IR validation, even when closure box analysis repurposes the `is_always_defined` flag, and update Linear IR golden tests to match the corrected lowering.

**Related Issues:**
- https://github.com/JuliaLang/julia/pull/60567#discussion_r2672556146

### Direct Changes

#### 1. `is_valid_body_ir_argument` now explicitly treats `BindingInfo.kind == :argument` as valid even if `is_always_defined` was cleared by closure box analysis, preventing arguments from being forced into temporary SSA assignments during Linear IR emission.

**Component**: JuliaLowering/src/linear_ir.jl

<details>
<summary>Evidence</summary>

**JuliaLowering/src/linear_ir.jl:101-112**
[View on GitHub](https://github.com/JuliaLang/julia/blob/bfcfc5b032664ba064e3dcd7c9d6942e6fb81e68/JuliaLowering/src/linear_ir.jl#L101-L112)
```julia
function is_valid_body_ir_argument(ctx, ex)
    if is_valid_ir_argument(ctx, ex)
        true
    elseif kind(ex) == K"BindingId"
        binfo = get_binding(ctx, ex)
        # arguments are inherently always-defined, but the closure
        # box analysis overrides this flag to mean "valid to leave
        # unboxed" so we check for them specifically here
        binfo.kind == :argument || binfo.is_always_defined
    else
        false
    end
end
```

</details>

#### 2. Linear IR golden tests are updated to show arguments/slots used directly in conditionals and conversions instead of round-tripping through temporary SSA values; this demonstrates the new argument-validity rule in practice.

**Component**: JuliaLowering/test/assignments_ir.jl

<details>
<summary>Evidence</summary>

**JuliaLowering/test/assignments_ir.jl:98-111**
[View on GitHub](https://github.com/JuliaLang/julia/blob/bfcfc5b032664ba064e3dcd7c9d6942e6fb81e68/JuliaLowering/test/assignments_ir.jl#L98-L111)
```julia
1   (newvar slot₁/x)
2   TestMod.f
3   (call %₂)
4   TestMod.T
5   (= slot₂/tmp %₃)
6   (call core.isa slot₂/tmp %₄)
7   (gotoifnot %₆ label₉)
8   (goto label₁₁)
9   (call top.convert %₄ slot₂/tmp)
10  (= slot₂/tmp (call core.typeassert %₉ %₄))
11  slot₂/tmp
12  (= slot₁/x %₁₁)
13  slot₁/x
14  (return %₁₃)
```

**JuliaLowering/test/assignments_ir.jl:98-113**
[View on GitHub](https://github.com/JuliaLang/julia/blob/143c2f598ebcad7b53ea407754067245e71a9691/JuliaLowering/test/assignments_ir.jl#L98-L113)
```julia
1   (newvar slot₁/x)
2   TestMod.f
3   (call %₂)
4   TestMod.T
5   (= slot₂/tmp %₃)
6   slot₂/tmp
7   (call core.isa %₆ %₄)
8   (gotoifnot %₇ label₁₀)
9   (goto label₁₃)
10  slot₂/tmp
11  (call top.convert %₄ %₁₀)
12  (= slot₂/tmp (call core.typeassert %₁₁ %₄))
13  slot₂/tmp
14  (= slot₁/x %₁₃)
15  slot₁/x
16  (return %₁₅)
```

</details>

### Secondary Effects

#### Linear IR emission can keep lambda arguments as direct `BindingId` operands in body IR (calls and conditionals) even when `is_always_defined` is cleared by closure boxing logic, reducing temporary SSA assignments and altering IR shapes in golden tests.

**Likelihood**: high | **Impact**: low

<details>
<summary>Mechanism</summary>

```
compile_args(ctx, args)  [linear_ir.jl:155-170]
  -> is_valid_body_ir_argument(ctx, arg_val)  [linear_ir.jl:101-112]
    checks binfo.kind == :argument || binfo.is_always_defined
  -> arguments now pass validation without emitting emit_assign_tmp
compile_condition_term(ctx, ex)  [linear_ir.jl:374-379]
  -> is_valid_body_ir_argument(ctx, cond)
  -> allows direct BindingId in gotoifnot conditions
```
</details>

**Downstream Surfaces:**
- Linear IR tests and any tooling that inspects JuliaLowering Linear IR output
- Debugging workflows that compare Linear IR text output

### Compatibility

#### Behavioral Changes
- Lowering/Linear IR output for argument-based expressions contains fewer temporary SSA values; user-visible semantics are unchanged but IR text snapshots differ.

### Performance

**Compile Time:**
- ESTIMATED: Slightly fewer `emit_assign_tmp` insertions for argument operands, reducing emitted Linear IR nodes by 1-3 per affected expression; negligible overall compile-time change.

### Risk Assessment

**Level**: low

**Rationale:**
- Change is localized to Linear IR validation for BindingId arguments and aligns with flisp behavior described in the PR description.
- Updated golden tests indicate the expected IR shape changes without altering runtime semantics.

### Recommendations

- If downstream tooling parses JuliaLowering Linear IR text output, update any golden expectations to allow direct BindingId operands for arguments in conditionals and conversions.
