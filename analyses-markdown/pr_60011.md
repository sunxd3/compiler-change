# PR #60011: fix `pointerarith_tfunc` for Const ptr

## Metadata

- **Author**: oscardssmith
- **URL**: https://github.com/JuliaLang/julia/pull/60011
- **Merged**: 2025-11-01 12:32 UTC
- **Labels**: `bugfix`
- **Diff**: https://github.com/JuliaLang/julia/pull/60011.diff

## Scope

### Files Touched
- `Compiler/src/tfuncs.jl`
- `Compiler/test/effects.jl`

### Components
- Compiler.tfuncs
- Compiler.tests

### Pipeline Stages
- TypeInference

## Analysis

### Intent

Fix pointer arithmetic type function so Const pointers are widened, matching runtime pointer arithmetic and preventing incorrect const propagation.

**Related Issues:**
- https://github.com/JuliaLang/julia/issues/60009

### Direct Changes

#### 1. Return widened pointer type for pointer arithmetic tfunc (instead of preserving Const pointer).

**Component**: Compiler/src/tfuncs.jl

<details>
<summary>Evidence</summary>

**Compiler/src/tfuncs.jl:710-712**
[View on GitHub](https://github.com/JuliaLang/julia/blob/97f880ae6d9c727a1ea8bb650b7578572f3e8972/Compiler/src/tfuncs.jl#L710-L712)
```julia
@nospecs function pointerarith_tfunc(ùïÉ::AbstractLattice, ptr, offset)
    return widenconst(ptr)
end
```

</details>

#### 2. Add regression test for pointer arithmetic from null pointer with offset (issue #60009).

**Component**: Compiler/test/effects.jl

<details>
<summary>Evidence</summary>

**Compiler/test/effects.jl:1491-1495**
[View on GitHub](https://github.com/JuliaLang/julia/blob/97f880ae6d9c727a1ea8bb650b7578572f3e8972/Compiler/test/effects.jl#L1491-L1495)
```julia
# https://github.com/JuliaLang/julia/issues/60009
function null_offset(offset)
    Ptr{UInt8}(C_NULL) + offset
end
@test null_offset(Int(100)) == Ptr{UInt8}(UInt(100))
```

</details>

### Secondary Effects

#### Pointer arithmetic on Const Ptr no longer yields a Const result type, reducing incorrect constant propagation for pointer addition/subtraction.

**Likelihood**: high | **Impact**: low

<details>
<summary>Mechanism</summary>

```
add_tfunc(add_ptr, 2, 2, pointerarith_tfunc, 1)  [Compiler/src/tfuncs.jl:756]
add_tfunc(sub_ptr, 2, 2, pointerarith_tfunc, 1)  [Compiler/src/tfuncs.jl:757]
-> find_tfunc(f) + T_FFUNC_VAL lookup  [Compiler/src/tfuncs.jl:60-88]
-> tf = T_FFUNC_VAL[fidx]  [Compiler/src/tfuncs.jl:2840-2846]
-> tf[3](ùïÉ·µ¢, argtypes...) dispatches pointerarith_tfunc  [Compiler/src/tfuncs.jl:2869-2870]
-> pointerarith_tfunc returns widenconst(ptr) (no Const preservation)  [Compiler/src/tfuncs.jl:710-712]
```
</details>

**Downstream Surfaces:**
- Core.Compiler abstract interpreter (builtin pointer arithmetic inference)
- Const-propagation users (JET/IRTools) that read inferred arg/result types

### Compatibility

#### Behavioral Changes
- Inference results for pointer arithmetic on Const Ptr are widened to Ptr types (no Const result), matching runtime behavior in tests.

### Performance

**Compile Time:**
- ESTIMATED: no measurable change; tfunc still a constant-time return with one widenconst call.

**Runtime:**
- ESTIMATED: no runtime performance change; affects inference/analysis only.

### Risk Assessment

**Level**: low

**Rationale:**
- Change is localized to a single tfunc return value and covered by a targeted regression test.

### Recommendations

- Downstream inference tools that assume Const preservation for Ptr arithmetic should update expectations to widened Ptr types.
