# PR #60297: Fix copy-paste error in effect comparison

## Metadata

- **Author**: Keno
- **URL**: https://github.com/JuliaLang/julia/pull/60297
- **Merged**: 2025-12-02 09:49 UTC
- **Diff**: https://github.com/JuliaLang/julia/pull/60297.diff

## Scope

### Files Touched
- `Compiler/src/effects.jl`

### Components
- Compiler.Effects

### Pipeline Stages
- TypeInference
- Effects

## Analysis

### Intent

Fix an effects-comparison bug so the effect_free bit is compared against the prior effect_free value (not the consistent bit).

### Direct Changes

#### 1. Correct the ALWAYS_TRUE effect_free comparison in is_better_effects to look at old.effect_free instead of old.consistent.

**Component**: Compiler.Effects

<details>
<summary>Evidence</summary>

**Compiler/src/effects.jl:205-225**
[View on GitHub](https://github.com/JuliaLang/julia/blob/758718094f4922a63816572fe8f0b1fe364bb559/Compiler/src/effects.jl#L205-L225)
```julia
function is_better_effects(new::Effects, old::Effects)
    any_improved = false
    if new.consistent == ALWAYS_TRUE
        any_improved |= old.consistent != ALWAYS_TRUE
    else
        if !iszero(new.consistent & CONSISTENT_IF_NOTRETURNED)
            old.consistent == ALWAYS_TRUE && return false
            any_improved |= iszero(old.consistent & CONSISTENT_IF_NOTRETURNED)
        elseif !iszero(new.consistent & CONSISTENT_IF_INACCESSIBLEMEMONLY)
            old.consistent == ALWAYS_TRUE && return false
            any_improved |= iszero(old.consistent & CONSISTENT_IF_INACCESSIBLEMEMONLY)
        else
            return false
        end
    end
    if new.effect_free == ALWAYS_TRUE
        any_improved |= old.effect_free != ALWAYS_TRUE
    elseif new.effect_free == EFFECT_FREE_IF_INACCESSIBLEMEMONLY
        old.effect_free == ALWAYS_TRUE && return false
        any_improved |= old.effect_free != EFFECT_FREE_IF_INACCESSIBLEMEMONLY
    elseif new.effect_free != old.effect_free
        return false
    end
```

</details>

#### 2. Existing tests assert effect_free results for removable-if-unused patterns (no test changes in this PR).

**Component**: Compiler.Tests

<details>
<summary>Evidence</summary>

**Compiler/test/effects.jl:637-655**
[View on GitHub](https://github.com/JuliaLang/julia/blob/758718094f4922a63816572fe8f0b1fe364bb559/Compiler/test/effects.jl#L637-L655)
```julia
for f = Any[removable_if_unused1, removable_if_unused2]
    effects = Base.infer_effects(f)
    @test Compiler.is_inaccessiblememonly(effects)
    @test Compiler.is_effect_free(effects)
    @test Compiler.is_removable_if_unused(effects)
    @test @eval fully_eliminated() do
        $f()
        nothing
    end
end
@noinline function removable_if_unused3(v)
    x = makeref()
    setref!(x, v)
    x
end
let effects = Base.infer_effects(removable_if_unused3, (Int,))
    @test Compiler.is_inaccessiblememonly(effects)
    @test Compiler.is_effect_free(effects)
    @test Compiler.is_removable_if_unused(effects)
end
```

</details>

### Secondary Effects

#### Const-prop inference will now accept effect_free improvements when type results are worse but effects improve.

**Likelihood**: medium | **Impact**: low

<details>
<summary>Mechanism</summary>

```
abstract_call_method_with_const_args(...)  [abstractinterpretation.jl:177]
  produces const_call_result.effects
-> is_better_effects(const_call_result.effects, effects)  [abstractinterpretation.jl:194]
  compares effect_free via old.effect_free in is_better_effects  [effects.jl:220-224]
-> effects updated to const-prop result when effect_free improves
```
</details>

**Downstream Surfaces:**
- Const-prop effect selection during inference
- Effect-based inlining / removal decisions

### Compatibility

#### Behavioral Changes
- Const-prop may retain effect_free improvements that were previously ignored due to the mistaken comparison against old.consistent.

### Performance

**Compile Time:**
- ESTIMATED: no measurable change; a single branch uses the correct field during comparison.

**Runtime:**
- ESTIMATED: no measurable change; effect metadata only influences optimizer decisions.

### Risk Assessment

**Level**: low

**Rationale:**
- Single-field comparison fix in an internal effect comparator, with narrow scope.

### Recommendations

- Downstream tooling that relies on effect_free outcomes from const-prop should re-run effect-related tests to confirm expectations.
