# PR #60232: Use jlutilities mechanism for external package required in test

## Metadata

- **Author**: Keno
- **URL**: https://github.com/JuliaLang/julia/pull/60232
- **Merged**: 2025-11-25 08:25 UTC
- **Diff**: https://github.com/JuliaLang/julia/pull/60232.diff

## Scope

### Files Touched
- `Compiler/extras/CompilerDevTools/test/testpkg.jl`
- `JuliaLowering/Manifest.toml`
- `JuliaLowering/test/runtests_vendored.jl`
- `deps/jlutilities/objectfile/Manifest.toml`
- `deps/jlutilities/objectfile/Project.toml`
- `test/runtests.jl`
- `test/stdlib_dependencies.jl`

### Components
- CompilerDevTools tests
- JuliaLowering tests
- jlutilities test depot
- Test harness

### Pipeline Stages
- Testing
- Package/Depot management

## Analysis

### Intent

Avoid installing ObjectFile.jl into the stdlib depot during tests by using the jlutilities vendored depot and by skipping the dependency test when ObjectFile is unavailable in deployed environments.

**Related Issues:**
- https://github.com/JuliaLang/julia/pull/60222

### Direct Changes

#### 1. Expose JULIA_TEST_BUILDROOT in the main test harness so downstream test helpers can locate the source-tree build root.

**Component**: Test harness

<details>
<summary>Evidence</summary>

**test/runtests.jl:17-38**
[View on GitHub](https://github.com/JuliaLang/julia/blob/1ba499652c86b11d42c08b042b22613c077662e2/test/runtests.jl#L17-L38)
```julia
(; tests, net_on, exit_on_error, use_revise, buildroot, seed) = choosetests(ARGS)
tests = unique(tests)

const rmwait_timeout = running_under_rr() ? 300 : 30

ENV["JULIA_TEST_BUILDROOT"] = buildroot
if use_revise
    # First put this at the top of the DEPOT PATH to install revise if necessary.
    # Once it's loaded, we swizzle it to the end, to avoid confusing any tests.
    pushfirst!(DEPOT_PATH, joinpath(buildroot, "deps", "jlutilities", "depot"))
    using Pkg
    Pkg.activate(joinpath(@__DIR__, "..", "deps", "jlutilities", "revise"))
    Pkg.instantiate()
    using Revise
    union!(Revise.stdlib_names, Symbol.(STDLIBS))
    push!(DEPOT_PATH, popfirst!(DEPOT_PATH))
```

</details>

#### 2. Switch stdlib dependency tests to load ObjectFile.jl from the vendored jlutilities depot when running from a source tree, and skip with a warning if the package is missing in deployed environments.

**Component**: Test harness

<details>
<summary>Evidence</summary>

**test/stdlib_dependencies.jl:6-34**
[View on GitHub](https://github.com/JuliaLang/julia/blob/1ba499652c86b11d42c08b042b22613c077662e2/test/stdlib_dependencies.jl#L6-L34)
```julia
# Load ObjectFile.jl from the vendored jlutilities depot
buildroot = get(ENV, "JULIA_TEST_BUILDROOT", joinpath(@__DIR__, ".."))
depspath = joinpath(buildroot, "deps", "jlutilities")
if ispath(depspath)
    depspath = realpath(depspath)
    # With a source-tree use the vendored depot
    pushfirst!(DEPOT_PATH, joinpath(depspath, "depot"))
    using Pkg
    old_active_project = Base.active_project()
    Base.redirect_stdout(devnull) do
        Base.redirect_stderr(devnull) do
            Pkg.activate(realpath(joinpath(@__DIR__, "..", "deps", "jlutilities", "objectfile")))
            Pkg.instantiate()
        end
    end
    using ObjectFile
    popfirst!(DEPOT_PATH)
    Base.set_active_project(old_active_project)
else
    # Without a source-tree - expect that the user has installed it for us - warn otherwise
    ObjectFile_pkgid = Base.PkgId(Base.UUID("d8793406-e978-5875-9003-1fc021f44a92"), "ObjectFile")
    if Base.locate_package(ObjectFile_pkgid) !== nothing
        @eval using ObjectFile
    end
end

if !@isdefined(ObjectFile)
    @warn("ObjectFile.jl not available; skipping stdlib JLL dependency tests")
```

</details>

#### 3. Remove Pkg.instantiate calls in CompilerDevTools and JuliaLowering tests to avoid writing to the stdlib depot; JuliaLowering now relies on a checked-in Manifest.toml.

**Component**: CompilerDevTools / JuliaLowering tests

<details>
<summary>Evidence</summary>

**Compiler/extras/CompilerDevTools/test/testpkg.jl:1-5**
[View on GitHub](https://github.com/JuliaLang/julia/blob/1ba499652c86b11d42c08b042b22613c077662e2/Compiler/extras/CompilerDevTools/test/testpkg.jl#L1-L5)
```julia
using Pkg

Pkg.activate(dirname(@__DIR__)) do
  include("runtests.jl")
end
```

**JuliaLowering/test/runtests_vendored.jl:1-18**
[View on GitHub](https://github.com/JuliaLang/julia/blob/1ba499652c86b11d42c08b042b22613c077662e2/JuliaLowering/test/runtests_vendored.jl#L1-L18)
```julia
old_active_project = Base.active_project()
try
    # test local (dev) copy of JuliaLowering, not yet vendored into Base
    Base.set_active_project(joinpath(@__DIR__, "..", "Project.toml"))
    manifest_path = joinpath(@__DIR__, "..", "Manifest.toml")

    # restore error hints (emptied by `testdefs.jl`) so that errors print as
    # JuliaLowering expects them to
    Base.Experimental.register_error_hint(Base.UndefVarError_hint, UndefVarError)

    # n.b.: these must be run in `Main`, so that type-printing is equivalent
    # when running via Pkg.test() (e.g. "SyntaxGraph" should be printed instead
    # of "JuliaLowering.SyntaxGraph")
    @eval Main using JuliaLowering
    Core.include(Main, joinpath(@__DIR__, "runtests.jl")) # run the actual tests
finally
    # Restore original load path and active project
    Base.set_active_project(old_active_project)
end
```

**JuliaLowering/Manifest.toml:1-16**
[View on GitHub](https://github.com/JuliaLang/julia/blob/1ba499652c86b11d42c08b042b22613c077662e2/JuliaLowering/Manifest.toml#L1-L16)
```julia
# This file is machine-generated - editing it directly is not advised

julia_version = "1.14.0-DEV"
manifest_format = "2.1"
project_hash = "16f6f8d58c46fe20d68a941bfaddb4590471548a"

[[deps.JuliaLowering]]
deps = ["JuliaSyntax"]
path = "."
uuid = "f3c80556-a63f-4383-b822-37d64f81a311"
version = "1.0.0-DEV"

[[deps.JuliaSyntax]]
path = "../JuliaSyntax"
uuid = "70703baa-626e-46a2-a12c-08ffd08c73b4"
version = "2.0.0-DEV"
```

</details>

#### 4. Introduce a jlutilities ObjectFile.jl project/manifest so the test harness can instantiate it from the vendored depot.

**Component**: jlutilities test depot

<details>
<summary>Evidence</summary>

**deps/jlutilities/objectfile/Project.toml:1-2**
[View on GitHub](https://github.com/JuliaLang/julia/blob/1ba499652c86b11d42c08b042b22613c077662e2/deps/jlutilities/objectfile/Project.toml#L1-L2)
```julia
[deps]
ObjectFile = "d8793406-e978-5875-9003-1fc021f44a92"
```

**deps/jlutilities/objectfile/Manifest.toml:1-28**
[View on GitHub](https://github.com/JuliaLang/julia/blob/1ba499652c86b11d42c08b042b22613c077662e2/deps/jlutilities/objectfile/Manifest.toml#L1-L28)
```julia
# This file is machine-generated - editing it directly is not advised

julia_version = "1.14.0-DEV"
manifest_format = "2.1"
project_hash = "23b8253b8eadb7ba5d7489bb56f38819b7150654"

[[deps.ObjectFile]]
deps = ["Reexport", "StructIO"]
git-tree-sha1 = "22faba70c22d2f03e60fbc61da99c4ebfc3eb9ba"
registries = "General"
uuid = "d8793406-e978-5875-9003-1fc021f44a92"
version = "0.5.0"

[[deps.Reexport]]
git-tree-sha1 = "45e428421666073eab6f2da5c9d310d99bb12f9b"
registries = "General"
uuid = "189a3867-3050-52da-a836-e630ba90ab69"
version = "1.2.2"

[[deps.StructIO]]
git-tree-sha1 = "c581be48ae1cbf83e899b14c07a807e1787512cc"
registries = "General"
uuid = "53d494c1-5632-5724-8f4c-31dff12d585f"
version = "0.3.1"

[registries.General]
url = "https://github.com/JuliaRegistries/General.git"
uuid = "23338594-aafe-5451-b93e-139f81909106"
```

</details>

### Secondary Effects

#### Stdlib JLL dependency checks now depend on JULIA_TEST_BUILDROOT to locate the jlutilities depot and avoid mutating the stdlib depot.

**Likelihood**: high | **Impact**: medium

<details>
<summary>Mechanism</summary>

```
test/runtests.jl sets ENV["JULIA_TEST_BUILDROOT"] = buildroot  [test/runtests.jl:17-31]
  -> test/stdlib_dependencies.jl reads buildroot = get(ENV, "JULIA_TEST_BUILDROOT", ...)  [test/stdlib_dependencies.jl:6-8]
  -> when deps/jlutilities exists, DEPOT_PATH is prepended and Pkg.activate(...) + Pkg.instantiate() run  [test/stdlib_dependencies.jl:12-19]
  -> ObjectFile is loaded from the vendored depot and tests proceed  [test/stdlib_dependencies.jl:21-34]
```
</details>

**Downstream Surfaces:**
- Julia test harness
- jlutilities vendored depot

#### In deployed test environments without the source tree, the stdlib JLL dependency tests are skipped with a warning instead of forcing a Pkg.add into the stdlib depot.

**Likelihood**: high | **Impact**: low

<details>
<summary>Mechanism</summary>

```
test/stdlib_dependencies.jl falls back to Base.locate_package(ObjectFile_pkgid)  [test/stdlib_dependencies.jl:25-28]
  -> if ObjectFile is not defined, it emits a warning and skips the test body  [test/stdlib_dependencies.jl:32-34]
```
</details>

**Downstream Surfaces:**
- Pkg/stdlib dependency test coverage
- CI configurations that do not preinstall ObjectFile.jl

### Compatibility

#### Internal API Changes
- **ENV["JULIA_TEST_BUILDROOT"]**: Newly set in test/runtests.jl for downstream test helpers to locate the jlutilities depot.

#### Behavioral Changes
- stdlib dependency tests no longer implicitly install ObjectFile.jl; they require a vendored jlutilities depot or preinstalled ObjectFile.jl and otherwise skip with a warning.

### Performance

**Compile Time:**
- {'description': 'ESTIMATED: negligible compile-time impact; changes are confined to test harness setup and Pkg activation for ObjectFile.jl.'}

**Runtime:**
- {'description': 'ESTIMATED: test runtime may decrease slightly by avoiding temp-environment Pkg.add; ObjectFile.jl instantiation now uses a pinned manifest in deps/jlutilities/objectfile.'}

### Risk Assessment

**Level**: low

**Rationale:**
- Changes are confined to test harness setup and vendored dependency management.
- Behavior is gated by the presence of a source tree or preinstalled ObjectFile.jl, with a warning and skip otherwise.

### Recommendations

- Ensure CI/test runners set or inherit JULIA_TEST_BUILDROOT when running test/stdlib_dependencies.jl outside the standard test harness.
- Keep the jlutilities ObjectFile.jl manifest in sync with the version expectations of stdlib dependency tests.
