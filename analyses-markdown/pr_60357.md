# PR #60357: Fix `replace_beginend` with `kw`

## Metadata

- **Author**: mlechu
- **URL**: https://github.com/JuliaLang/julia/pull/60357
- **Merged**: 2025-12-11 00:28 UTC
- **Labels**: `JuliaLowering`
- **Diff**: https://github.com/JuliaLang/julia/pull/60357.diff

## Scope

### Files Touched
- `JuliaLowering/src/desugaring.jl`
- `JuliaLowering/test/arrays.jl`

### Components
- JuliaLowering

### Pipeline Stages
- Lowering

## Analysis

### Intent

Match flisp behavior by avoiding begin/end replacement in keyword argument names inside indexing expressions.

**Related Issues:**
- https://github.com/JuliaLang/julia/issues/60309

### Direct Changes

#### 1. Handle K"kw" nodes in replace_beginend so only the keyword value is rewritten, preserving keyword identifiers like var"begin"/var"end".

**Component**: JuliaLowering/desugaring

<details>
<summary>Evidence</summary>

**JuliaLowering/src/desugaring.jl:581-621**
[View on GitHub](https://github.com/JuliaLang/julia/blob/1806b0bc31d262ed7181162f6caeb8e8b944ddae/JuliaLowering/src/desugaring.jl#L581-L621)
```julia
function replace_beginend(ctx, ex, arr, n, splats, is_last)
    k = kind(ex)
    if k == K"Identifier" && ex.name_val in ("begin", "end")
        indexfunc = @ast ctx ex (ex.name_val == "begin" ? "firstindex" : "lastindex")::K"top"
        if length(splats) == 0
            if is_last && n == 1
                @ast ctx ex [K"call" indexfunc arr]
            else
                @ast ctx ex [K"call" indexfunc arr n::K"Integer"]
            end
        else
            splat_lengths = SyntaxList(ctx)
            for splat in splats
                push!(splat_lengths, @ast ctx ex [K"call" "length"::K"top" splat])
            end
            @ast ctx ex [K"call"
                indexfunc
                arr
                [K"call"
                    "+"::K"top"
                    (n - length(splats))::K"Integer"
                    splat_lengths...
                ]
            ]
        end
    elseif is_leaf(ex) || is_quoted(ex)
        ex
    elseif k == K"ref"
        # inside ref, only replace within the first argument
        @ast ctx ex [k
            replace_beginend(ctx, ex[1], arr, n, splats, is_last)
            ex[2:end]...
        ]
    elseif k == K"kw"
        # note from flisp
        # TODO: this probably should not be allowed since keyword args aren't
        # positional, but in this context we have just used their positions anyway
        @ast ctx ex [K"kw" ex[1] replace_beginend(ctx, ex[2], arr, n, splats, is_last)]
    else
        mapchildren(e->replace_beginend(ctx, e, arr, n, splats, is_last), ctx, ex)
    end
end
```

</details>

#### 2. Added tests asserting begin/end identifiers are preserved in keyword names, quoted identifiers, and explicit var"end" bindings during indexing.

**Component**: JuliaLowering/tests

<details>
<summary>Evidence</summary>

**JuliaLowering/test/arrays.jl:148-160**
[View on GitHub](https://github.com/JuliaLang/julia/blob/1806b0bc31d262ed7181162f6caeb8e8b944ddae/JuliaLowering/test/arrays.jl#L148-L160)
```julia
# begin/end not replaced in some cases
JuliaLowering.include_string(test_mod, "f(args...;kws...) = 2")
@test JuliaLowering.include_string(test_mod, """
    [7,8,9][f(;var\"end\"=123, var\"begin\"=456)]
""") === 8
@test JuliaLowering.include_string(test_mod, """
    [7,8,9][f(quote var\"end\" end)]
""") === 8
@test JuliaLowering.include_string(test_mod, """
let var\"end\" = [1,2,3], y = [7,8,9]
    y[var\"end\"[var\"end\"]]
end
""") === 9
```

</details>

### Secondary Effects

#### Keyword-argument names that are literally begin/end no longer get rewritten to firstindex/lastindex during indexing desugaring.

**Likelihood**: high | **Impact**: low

<details>
<summary>Mechanism</summary>

```
replace_beginend(ctx, ex, arr, n, splats, is_last)  [desugaring.jl:581-621]
  handles K"kw" by rewriting only ex[2] (keyword value)
-> process_indices(sctx, arr, idxs)  [desugaring.jl:629-645]
  calls replace_beginend for each index expression
-> expand_ref_components(sctx, ex)  [desugaring.jl:651-660]
  uses process_indices for ref nodes
-> expand_forms_2(ctx, ex) handles K"ref"  [desugaring.jl:4550-4568]
  emits getindex call with rewritten indices
```
</details>

**Downstream Surfaces:**
- Indexing lowering (getindex/setindex!/dotview)
- Macros/tools that reason about lowered SyntaxTree for array refs

### Compatibility

#### Behavioral Changes
- Index expressions that include keyword arguments with names var"begin"/var"end" now preserve those identifiers instead of rewriting them to firstindex/lastindex calls.

### Performance

### Risk Assessment

**Level**: low

**Rationale:**
- Change is localized to lowering of begin/end within keyword argument nodes in indexing expressions.
- Tests lock in the intended behavior for keyword names and quoted identifiers.

### Recommendations

- Downstream tooling that inspects lowered SyntaxTree for array refs should ensure keyword name identifiers are preserved and only keyword values are eligible for begin/end rewriting.
