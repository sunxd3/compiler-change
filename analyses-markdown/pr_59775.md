# PR #59775: deprecate `merge(::Callable ..)` in favor of `mergewith`

## Metadata

- **Author**: adienes
- **URL**: https://github.com/JuliaLang/julia/pull/59775
- **Merged**: 2025-10-27 17:05 UTC
- **Labels**: `deprecation`, `collections`
- **Diff**: https://github.com/JuliaLang/julia/pull/59775.diff

## Scope

### Files Touched
- `Compiler/test/inference.jl`
- `NEWS.md`
- `base/deprecated.jl`
- `test/dict.jl`

### Components
- Compiler.Tests
- Compiler.Base

### Pipeline Stages
- Tests
- RuntimeLibrary

## Analysis

### Intent

Deprecate the Callable-combiner overload of merge(::AbstractDict...) in favor of mergewith, and update tests and NEWS to reflect the preferred API.

**Related Issues:**
- https://github.com/JuliaLang/julia/pull/34296
- https://github.com/JuliaLang/julia/issues/43491#issuecomment-1004364287

### Direct Changes

#### 1. Introduce a 1.13 deprecation redirecting merge(combine::Callable, d::AbstractDict, ...) to mergewith.

**Component**: Base deprecations

<details>
<summary>Evidence</summary>

**base/deprecated.jl:570-573**
[View on GitHub](https://github.com/JuliaLang/julia/blob/595757964be1e190e8fe474b74df7a60b315e566/base/deprecated.jl#L570-L573)
```julia
# BEGIN 1.13 deprecations

@deprecate merge(combine::Callable, d::AbstractDict, others::AbstractDict...) mergewith(combine, d, others...)

# end 1.13 deprecations
```

</details>

#### 2. Update the inference regression test for MixedKeyDict to use mergewith instead of merge with a combiner function.

**Component**: Compiler test suite

<details>
<summary>Evidence</summary>

**Compiler/test/inference.jl:3509-3542**
[View on GitHub](https://github.com/JuliaLang/julia/blob/595757964be1e190e8fe474b74df7a60b315e566/Compiler/test/inference.jl#L3509-L3542)
```julia
struct MixedKeyDict{T<:Tuple} #<: AbstractDict{Any,Any}
    dicts::T
end
Base.mergewith(f::Function, d::MixedKeyDict, others::MixedKeyDict...) = _merge(f, (), d.dicts, (d->d.dicts).(others)...)
Base.mergewith(f, d::MixedKeyDict, others::MixedKeyDict...) = _merge(f, (), d.dicts, (d->d.dicts).(others)...)
function _merge(f, res, d, others...)
    ofsametype, remaining = _alloftype(Base.heads(d), ((),), others...)
    return _merge(f, (res..., mergewith(f, ofsametype...)), Base.tail(d), remaining...)
end
_merge(f, res, ::Tuple{}, others...) = _merge(f, res, others...)
_merge(f, res, d) = MixedKeyDict((res..., d...))
_merge(f, res, ::Tuple{}) = MixedKeyDict(res)
function _alloftype(ofdesiredtype::Tuple{Vararg{D}}, accumulated, d::Tuple{D,Vararg}, others...) where D
    return _alloftype((ofdesiredtype..., first(d)),
                      (Base.front(accumulated)..., (last(accumulated)..., Base.tail(d)...), ()),
                      others...)
end
function _alloftype(ofdesiredtype, accumulated, d, others...)
    return _alloftype(ofdesiredtype,
                      (Base.front(accumulated)..., (last(accumulated)..., first(d))),
                      Base.tail(d), others...)
end
function _alloftype(ofdesiredtype, accumulated, ::Tuple{}, others...)
    return _alloftype(ofdesiredtype,
                      (accumulated..., ()),
                      others...)
end
_alloftype(ofdesiredtype, accumulated) = ofdesiredtype, Base.front(accumulated)
let
    d = MixedKeyDict((Dict(1 => 3), Dict(4. => 2)))
    e = MixedKeyDict((Dict(1 => 7), Dict(5. => 9)))
    @test mergewith(+, d, e).dicts == (Dict(1 => 10), Dict(4.0 => 2, 5.0 => 9))
    f = MixedKeyDict((Dict(2 => 7), Dict(5. => 11)))
    @test mergewith(+, d, e, f).dicts == (Dict(1 => 10, 2 => 7), Dict(4.0 => 2, 5.0 => 20))
end
```

</details>

#### 3. Remove the backward-compatibility test that exercised merge with a combiner and keep mergewith coverage.

**Component**: Base tests

<details>
<summary>Evidence</summary>

**test/dict.jl:1281-1291**
[View on GitHub](https://github.com/JuliaLang/julia/blob/595757964be1e190e8fe474b74df7a60b315e566/test/dict.jl#L1281-L1291)
```julia
@testset "Dict merge" begin
    d1 = Dict("A" => 1, "B" => 2)
    d2 = Dict("B" => 3.0, "C" => 4.0)
    @test @inferred merge(d1, d2) == Dict("A" => 1, "B" => 3, "C" => 4)
    # merge with combiner function
    @test @inferred mergewith(+, d1, d2) == Dict("A" => 1, "B" => 5, "C" => 4)
    @test @inferred mergewith(*, d1, d2) == Dict("A" => 1, "B" => 6, "C" => 4)
    @test @inferred mergewith(-, d1, d2) == Dict("A" => 1, "B" => -1, "C" => 4)
    @test @inferred mergewith(NonFunctionCallable(), d1, d2) == Dict("A" => 1, "B" => 5, "C" => 4)
    @test foldl(mergewith(+), [d1, d2]; init=Dict{Union{},Union{}}()) ==
        Dict("A" => 1, "B" => 5, "C" => 4)
end
```

</details>

#### 4. Add a NEWS entry documenting the deprecation of merge(combine::Callable, d::AbstractDict...).

**Component**: Release notes

<details>
<summary>Evidence</summary>

**NEWS.md:126-129**
[View on GitHub](https://github.com/JuliaLang/julia/blob/595757964be1e190e8fe474b74df7a60b315e566/NEWS.md#L126-L129)
```julia
Deprecated or removed
---------------------

* The method `merge(combine::Callable, d::AbstractDict...)` is now deprecated to favor `mergewith` instead ([#59775]).
```

</details>

### Secondary Effects

#### Calling merge(combine::Callable, d::AbstractDict...) now emits a deprecation warning and forwards to mergewith.

**Likelihood**: high | **Impact**: low

<details>
<summary>Mechanism</summary>

```
merge(combine::Callable, d::AbstractDict, others::AbstractDict...)  [base/abstractdict.jl:408-409]
  defines the Callable-combiner overload
-> @deprecate wrapper  [base/deprecated.jl:570-573]
  emits depwarn and redirects to mergewith(combine, d, others...)
-> mergewith(combine, d::AbstractDict, others::AbstractDict...)  [base/abstractdict.jl:405-406]
  performs the combining merge
```
</details>

**Downstream Surfaces:**
- User code calling merge(+, dicts...)
- Packages that overload merge(combine::Callable, ::AbstractDict...)

### Compatibility

#### Internal API Changes
- **Field**: Deprecated via @deprecate and redirected to mergewith; call sites should migrate to mergewith to avoid depwarns.

#### Behavioral Changes
- Calls to merge(+, dicts...) now trigger a deprecation warning in 1.13.

### Performance

**Compile Time:**
- ESTIMATED: negligible; only adds deprecation check on use of merge(combine::Callable, ...).

**Runtime:**
- ESTIMATED: negligible; existing mergewith path is reused after deprecation wrapper.

### Risk Assessment

**Level**: low

**Rationale:**
- No compiler pipeline behavior changes; this is a Base API deprecation with tests updated to the preferred API.
- Runtime behavior remains the same aside from a deprecation warning for Callable-based merge.

### Recommendations

- Update downstream code that calls merge(+, dicts...) to mergewith(+, dicts...) to avoid deprecation warnings.
- If you define custom merge(combine::Callable, ::AbstractDict...) methods, consider adding corresponding mergewith overloads.
